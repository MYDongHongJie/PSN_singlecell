# encoding:utf-8
#temp
# sys.path.extend(["/data/software/conda_envs/oebio/lib/python3.8/site-packages/",
#    "/data/software/conda_envs/oebio/lib/python3.8/site-packages/lxml-4.6.2-py3.8-linux-x86_64.egg/"])#markupsafe
#a=['/home/hanmin/miniconda3/envs/OESingleCell/lib/python3.7/site-packages', '/data/software/conda_envs/oebio/lib/python38.zip', '/data/software/conda_envs/oebio/lib/python3.8', '/data/software/conda_envs/oebio/lib/python3.8/lib-dynload', '/data/software/conda_envs/oebio/lib/python3.8/site-packages', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/XlsxWriter-1.3.7-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/xlrd-1.2.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pypinyin-0.40.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Pillow-8.1.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/PyPDF2-1.26.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/tzlocal-3.0b1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/openpyxl-3.0.6-py3.8.egg','/data/software/conda_envs/oebio/lib/python3.8/site-packages/patsy-0.5.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/requests-2.25.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pdf2image-1.11.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/python_docx-0.8.10-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/sklearn-0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/xlwt-1.3.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/scikit_learn-0.24.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Markdown-3.3.3-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/watchdog-1.0.2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/six-1.15.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/seaborn-0.11.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Click-7.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/statsmodels-0.12.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/matplotlib_venn-0.11.6-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/biopython-1.78-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Jinja2-3.0.0a1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/PyYAML-5.4b2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/scipy-1.6.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/networkx-2.5-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/matplotlib-3.3.3-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/backports.zoneinfo-0.2.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/jdcal-1.4.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/et_xmlfile-1.0.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/urllib3-1.26.2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/idna-2.10-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/chardet-4.0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/lxml-4.6.2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/threadpoolctl-2.1.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/joblib-1.0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/MarkupSafe-2.0.0a1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/decorator-4.4.2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pyparsing-3.0.0b2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/kiwisolver-1.3.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/cycler-0.10.0-py3.8.egg']
#sys.path.extend(a)

# 二.文件缺失
# module 缺失 - WARNING
# module 内生成报告所需文件缺失 - error
# module 内非报告生成所必须文件缺失（cellranger 结果） - warning
CLEAR='\033[0m'
ERROR='\033[1;31m' # 必须被修改的
WARNING='\033[1;33m' # 必须再人工检查确认的
MESSAGE='\033[1;32m' # 辅助信息

def logging(message,log_file,color = MESSAGE):
    print(color + message+ CLEAR)
    log_file.write(message + "\n")

def logging_exit(message,log_file,color = ERROR):
    log_file.write("ERROR:"+ message + "\n")
    log_file.close()
    sys.exit(color + message + " Exiting..." + CLEAR)

def check_exist(file,destination,log_file):
    if not os.path.exists(file): 
        logging_exit(file + " not found!",log_file)
    else:
        subprocess.call('cp -r '+file+' '+destination, shell=True)

def check_file_num(dir,destination,num,log_file):
    file_num_tmp = [check_exist(f"{dir}/{f}",destination,log_file) 
        for f in os.listdir(dir) 
        if re.search(r'.*\.(pdf|png|svg|csv|xls|tsv)$', f)]
    if not len(file_num_tmp) == num :
        logging(destination+" 目录下 "+str(len(file_num_tmp))+" 个文件, 应有 "+str(num)+" 个文件!" ,log_file)

#定义函数批量获取路径
def get_url(target,tag):
    urls = []
    for f in Path(target).glob(tag):
        text = f'[{f}]({f})\n\n'
        urls.append(text)
    return ''.join(urls)

import sys,shutil,os,click,subprocess,sys,re,time,yaml,re
from oebio.report import oeweb_register,Report
from oebio.app import *

@click.command()
@click.option('-i','--program_path', prompt='the program path',default = './result',
             help='the directory of your program.')
@click.option('-c','--configfile', prompt='config file', default='./config/config.yaml',
             help='the config file which contain your program information.')

def mobivision_report(program_path, configfile):
    """ python3 scRNA_report.py  -i ./ -c ./config.txt"""
    cfg = open(configfile, 'r', encoding='utf-8').read()
    config = yaml.full_load(cfg)
    program_path = os.path.abspath(program_path)
    orig_path = os.getcwd()
    ## params from config 
    program_num = dict(config['report'])['Task_Num']
    report_time = time.strftime("%Y_%m_%d")  #report_time=config['report']['Project_End_Time']
    outdir = f"report/{program_num}_QC_Report_{report_time}" 
    scriptdir = os.path.dirname(os.path.realpath(__file__))
    log_file = open(f"{program_path}/mobivision_report_log.txt", "w")
    ####################################################################################################
    ## ========================= 一、 1.Create directory  =========================
    ####################################################################################################
    os.chdir(program_path)
    if os.path.exists(outdir):
        shutil.rmtree(outdir, ignore_errors=True)
    os.makedirs(outdir)
    logging("____1. Creating Report..._____",log_file)

    module_num = 0
    ## ========================= 1.1 mobivision =========================
    if not os.path.exists("mobivision" ):
        logging("[mobivision module] × ",log_file,WARNING)
        import csv
        with open("../config/samples.csv", "r", encoding='UTF-8') as file:
            reader = csv.DictReader(file)
            sample_name = [row['sampleid'] for row in reader]
    else:
        module_num += 1
        logging("[mobivision module] √ ",log_file)
        Sample_Num = config['report']['Sample_Num']
        sample_name = [str(i).split('/')[-3] for i in glob("mobivision/*/outs/filtered_cell_gene_matrix" )]
        file_number ={i: len(os.listdir("mobivision/"+i+"/outs/")) for i in sample_name }
        
        # each sample
        for j in sample_name:
            os.makedirs(f"{outdir}/{module_num}.MobiVision/{j}" )
            subprocess.call(f'ln -s {program_path}/mobivision/{j}/outs/* {outdir}/{module_num}.MobiVision/{j} ', shell=True)
        #        if os.path.exists(f"{outdir}/{module_num}.CellRanger/{j}/possorted_genome_bam.bam" ):
        #     subprocess.call(f'rm {outdir}/{module_num}.CellRanger/{j}/possorted_genome_bam.bam*', shell=True)
        # png
            check_exist(
                        file=f"mobivision/{j}.png",
                        destination= f"{outdir}/{module_num}.MobiVision/" ,
                        log_file=log_file
                        )

####################################################################################################
## ========================= 二、2.Generate report =========================
####################################################################################################
    os.chdir(outdir)
    logging("____2. Generating Report..._____",log_file)
    # Define header info
    header_info = {key: config["report"][key] for key in config["report"] if
               key in ["Project_Num", "Customer", "Species", "Sample_Num", "Task_Num"]}
    header_info["订单编号"] = header_info.pop("Project_Num")
    header_info["客户姓名"] = header_info.pop("Customer")
    header_info["物种信息"] = header_info.pop("Species")
    header_info["样本数量"] = header_info.pop("Sample_Num")
    header_info["任务单号"] = header_info.pop("Task_Num")
    report = Report('MobiNova单细胞转录组项目结题报告', title = 'MobiNova单细胞转录组项目结题报告', header_info = dict(header_info), oe_welcome='''
    ####  感谢您选择欧易生物！

**关于网页报告使用有以下几点提示:**

1. **报告正文**中的**蓝色字体**均可以**点击**快速导引到感兴趣的章节，便于您快速查看相应内容。
2. **报告正文**中的**图片**均可以点击后进行**放大查看**，且图片点击后可以包含更多的细节信息，比如左上角会显示具体的**图片数量**，右上角有相关的**图片工具**，**键盘上的左右方向键/鼠标滚轮**可以对图片进行**切换**。
3. **报告正文**中**每个区域**中图片的数量**最多**只显示2张，更多的图片可以在点击之后在弹出界面利用**键盘方向键/鼠标滚轮**查看。
4. 展示的表格均可以在各列**表头**进行**升序或者降序显示**，当表格多于20行的时候，表格会嵌入到网页之中，可以利用滚动栏进行调整设置，同时会在表格上方增加搜索设置，便于快速查询表格信息。
5. 在报告中浏览，需要返回顶部的时候，可以使用网页**右下角的白色箭头标识**快速返回顶部。
6. 本提示可以点击右上方的不再显示，则后续打开网页均不会显示本提示。
    ''')
    report.add_yaml_config(os.path.join(scriptdir, 'report.yaml'))
    os.environ['OEBIO'] = os.path.join(scriptdir,"pic")
    os.environ['oeweb_register_token'] = 'oearray'
    ## test
    # project_module1 = report.add_section('项目概况')
    # project_module2 = report.add_section('项目概况')
    # project_module2.add_comment("comment1")
    # project_module1.add_comment("comment2")
    # report.write_to('report.html')
    # sys.exit()
    ############################################################################
    ## ========================= 2.1 SECTION1 项目概况 ========================= 
    ############################################################################
    summ = pd.read_csv("../../mobivision_sum/summary_stat.csv",index_col=0, sep=',', thousands=',')
    if summ.shape[0] > 1:
        QC_description = f'''本次分析完成 {summ.shape[0]} 个样本的单细胞转录组测序，各样本 Mobivision 定量质控的高质量细胞数分布在 {min(summ['Estimated Number of Cells'])} ~ {max(summ['Estimated Number of Cells'])} 个'''
    else:
        QC_description = f'''本次分析完成 {summ.shape[0]} 个样本的单细胞转录组测序，各样本 Mobivision 定量质控的高质量细胞数分布在 {min(summ['Estimated Number of Cells'])} 个''' 
    project_module = report.add_section('项目概况',description = QC_description)
    report_hyperlink_list = []
    ## ========================= 2.2.1 建库测序流程 =========================  
    library_module = report.add_section('实验技术流程')
    library_module.add_comment('实验建库测序流程图如下：')
    library_module.add_plot('Experiment.png',caption ='建库测序流程图',content='建库测序流程图')
    ###############################################################################
    ## ========================= 2.3 SECTION3 生信分析流程 ========================= 
    ###############################################################################
    analysis_module = report.add_section('Mobivision分析流程')
    analysis_module.add_comment('Mobivision分析流程图如下：')
    analysis_module.add_plot('QC_only_pipeline.png', caption = 'Mobivision分析流程',content='Mobivision分析流程图')
    ###############################################################################
    ## ========================= 2.4 SECTION4 项目分析结果 ========================= 
    ###############################################################################
    result_module = report.add_section('项目分析结果')
    
    ## ========================= 2.4.1 基因定量质控 =========================  
    if len(list(glob("*.MobiVision"))) != 0:
        report_hyperlink_list.append('[样本质控结果](#MobiVision)\n\n')
        MobiVision = result_module.add_section('基因定量质控')
        MobiVision_plots = sorted(list(glob('*.MobiVision/*.png')),reverse=False)
        MobiVision_plots = list(zip(MobiVision_plots, ['样本细胞质量统计结果']*len(MobiVision_plots)))
        MobiVision.add_plot(MobiVision_plots, caption = '样本细胞质量统计结果')
        MobiVision.add_table("../../mobivision_sum/summary_stat.csv", caption = '样本细胞质量统计结果')
        MobiVision.add_table('../../../scripts/report/pic/tables/scRNA_qc_stat.txt', caption = '样本细胞质量统计结果说明')
        link = f'[{list(glob("*.MobiVision"))[0]}]({list(glob("*.MobiVision"))[0]})\n\n'
        MobiVision.add_comment("详细结果目录见 : ")
        MobiVision.add_comment("{link}",link=link)
        


    #########################################################################
    ## ========================= 2.5 SECTION 5 附录 ========================= 
    #########################################################################
    appendix_module = report.add_section('附录')


## ========================= 2.5.6 软件及数据库信息  ========================= 
    #database = pd.DataFrame([['GO Database','http://geneontology.org/'],['KEGG Database','http://www.genome.jp/kegg/']])
    # database.columns = ['使用数据库', '网页链接']
    scRNA_database = pd.read_table('../../../scripts/report/pic/tables/scRNA_database.txt', sep='\t')
    database = pd.DataFrame(columns = scRNA_database.columns)
    with open(f'{config["report"]["Reference"]}/config.yaml') as f:
        reference_config=yaml.safe_load(f)
    database = database.append([{"使用数据库":"Reference genome","网页链接":reference_config["genome_linkage"],"版本":reference_config["genome_version"]}])
    database = database.append([{"使用数据库":"Reference genome annotation","网页链接":reference_config["annotation_linkage"],"版本":reference_config["annotation_version"]}])

    supply_section_database = appendix_module.add_section('数据库信息',description='')
    supply_section_database.add_table(database,caption='数据库信息')
    software = pd.read_table('../../../scripts/report/pic/tables/scRNA_software.txt', sep='\t')
    mobivision_version = config['mobivision_params']['version']
    software["Version"][0] = mobivision_version
    software = software[software.Software.isin(['MobiVision'])]
    supply_section_software = appendix_module.add_section('数据分析软件')
    supply_section_software.add_table(software, caption = '使用软件及版本')

    #########################################################################
    ## ========================= 2.6 SECTION 6 申明 =========================
    #########################################################################
    report.add_section('申明')
    
    #########################################################################
    ## =========================   3.  写入html     =========================
    #########################################################################
    # Generate Report HTML
    report.write_to('质控说明.html', zip_report_name=f'../{outdir}.zip' )
    log_file.close()

if __name__ == "__main__":
    mobivision_report()


    
