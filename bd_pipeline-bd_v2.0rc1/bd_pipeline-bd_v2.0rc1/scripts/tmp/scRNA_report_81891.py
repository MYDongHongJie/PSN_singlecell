# encoding:utf-8
#temp
# sys.path.extend(["/data/software/conda_envs/oebio/lib/python3.8/site-packages/",
#	"/data/software/conda_envs/oebio/lib/python3.8/site-packages/lxml-4.6.2-py3.8-linux-x86_64.egg/"])#markupsafe
#a=['/home/hanmin/miniconda3/envs/OESingleCell/lib/python3.7/site-packages', '/data/software/conda_envs/oebio/lib/python38.zip', '/data/software/conda_envs/oebio/lib/python3.8', '/data/software/conda_envs/oebio/lib/python3.8/lib-dynload', '/data/software/conda_envs/oebio/lib/python3.8/site-packages', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/XlsxWriter-1.3.7-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/xlrd-1.2.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pypinyin-0.40.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Pillow-8.1.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/PyPDF2-1.26.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/tzlocal-3.0b1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/openpyxl-3.0.6-py3.8.egg','/data/software/conda_envs/oebio/lib/python3.8/site-packages/patsy-0.5.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/requests-2.25.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pdf2image-1.11.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/python_docx-0.8.10-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/sklearn-0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/xlwt-1.3.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/scikit_learn-0.24.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Markdown-3.3.3-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/watchdog-1.0.2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/six-1.15.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/seaborn-0.11.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Click-7.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/statsmodels-0.12.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/matplotlib_venn-0.11.6-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/biopython-1.78-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/Jinja2-3.0.0a1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/PyYAML-5.4b2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/scipy-1.6.0-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/networkx-2.5-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/matplotlib-3.3.3-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/backports.zoneinfo-0.2.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/jdcal-1.4.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/et_xmlfile-1.0.1-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/urllib3-1.26.2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/idna-2.10-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/chardet-4.0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/lxml-4.6.2-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/threadpoolctl-2.1.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/joblib-1.0.0-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/MarkupSafe-2.0.0a1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/decorator-4.4.2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/pyparsing-3.0.0b2-py3.8.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/kiwisolver-1.3.1-py3.8-linux-x86_64.egg', '/data/software/conda_envs/oebio/lib/python3.8/site-packages/cycler-0.10.0-py3.8.egg']
#sys.path.extend(a)

# 二.文件缺失
# module 缺失 - WARNING
# module 内生成报告所需文件缺失 - error
# module 内非报告生成所必须文件缺失（cellranger 结果） - warning
CLEAR='\033[0m'
ERROR='\033[1;31m' # 必须被修改的
WARNING='\033[1;33m' # 必须再人工检查确认的
MESSAGE='\033[1;32m' # 辅助信息

def logging(message,log_file,color = MESSAGE):
	print(color + message+ CLEAR)
	log_file.write(message + "\n")

def logging_exit(message,log_file,color = ERROR):
	log_file.write("ERROR:"+ message + "\n")
	log_file.close()
	sys.exit(color + message + " Exiting..." + CLEAR)

def check_exist(file,destination,log_file):
	if not os.path.exists(file): 
		logging_exit(file + " not found!",log_file)
	else:
		subprocess.call('cp -r '+file+' '+destination, shell=True)

def check_file_num(dir,destination,num,log_file):
	file_num_tmp = [check_exist(f"{dir}/{f}",destination,log_file) 
		for f in os.listdir(dir) 
		if re.search(r'.*\.(pdf|png|svg|csv|xls|tsv)$', f)]
	if not len(file_num_tmp) == num :
		logging(destination+" 目录下 "+str(len(file_num_tmp))+" 个文件, 应有 "+str(num)+" 个文件!" ,log_file)

#定义函数批量获取路径
def get_url(target,tag):
	urls = []
	for f in Path(target).glob(tag):
		text = f'[{f}]({f})\n\n'
		urls.append(text)
	return ''.join(urls)

import sys,shutil,os,click,subprocess,sys,re,time,yaml,re
from oebio.report import oeweb_register,Report
from oebio.app import *

@click.command()
@click.option('-i','--program_path', prompt='the program path',default = './result',
			 help='the directory of your program.')
@click.option('-c','--configfile', prompt='config file', default='./config/config.yaml',
			 help='the config file which contain your program information.')
@click.option('-r','--rds',
			 help='the rds file of the report.')

def scrna_report(program_path, configfile, rds):
	""" python3 scRNA_report.py  -i ./ -c ./config.txt"""
	cfg = open(configfile, 'r', encoding='utf-8').read()
	config = yaml.load(cfg)
	program_path = os.path.abspath(program_path)
	orig_path = os.getcwd()
	## params from config 
	program_num = dict(config['report'])['Project_Num']
	report_time = time.strftime("%Y_%m_%d")  #report_time=config['report']['Project_End_Time']
	vdj_type = config['BD_params']['VDJ']
	outdir = f"report/{program_num}_Report_{report_time}" 
	scriptdir = os.path.dirname(os.path.realpath(__file__))
	log_file = open(f"{program_path}/report_log.txt", "w")
	####################################################################################################
	## ========================= 一、 1.Create directory  =========================
	####################################################################################################
	os.chdir(program_path)
	if os.path.exists(outdir):
		shutil.rmtree(outdir, ignore_errors=True)
	os.makedirs(outdir)
	logging("____1. Creating Report..._____",log_file)

	module_num = 0
	## ========================= 1.1 cellranger =========================
	if not os.path.exists("BD_Analysis" ):
		logging("[BD Analysis module] × ",log_file,WARNING)
	else:
		module_num += 1
		logging("[BD_Analysis module] √ ",log_file)
		Sample_Num = config['report']['Sample_Num']
		sample_name = [str(i).split('/')[-2] for i in glob("BD_Analysis/*/*.html" )]
		file_number ={i: len(os.listdir("BD_Analysis/"+i+"/")) for i in sample_name }
		#if any([v!= 24 and v !=17 and v != 21 and v !=14 for k,v in file_number.items()]):
		if any([v!= 17 and v !=15 and v !=12  and v != 10 and v != 11 for k,v in file_number.items()]):
			logging("[BD_Analysis module] BD_Analysis/ 目录下各样本文件数 :" +  str(file_number) + "；每个样本应有17/12，11(表面蛋白) 或15/10 个文件,。默认为外来数据不提供BD_Analysis结果。Skipping... \n[BD_Analysis module] × " ,log_file,WARNING)
			module_num -= 1
		else:
			if len(sample_name) != Sample_Num:
				logging_exit("[BD_Analysis module] Number of samples(from config.yaml) does not match the number of cellranger directory!",log_file)
			else:
				# each sample
				for j in sample_name:
					os.makedirs(f"{outdir}/{module_num}.BD_Analysis/{j}" )
					#subprocess.call(f'ln -s {program_path}/BD_Analysis/{j}/*_Pipeline_Report.html {outdir}/{module_num}.BD_Analysis/{j} ', shell=True)
					#subprocess.call(f'ln -s {program_path}/BD_Analysis/{j}/*_Metrics_Summary.csv {outdir}/{module_num}.BD_Analysis/{j} ', shell=True)
					subprocess.call(f'ln -s {program_path}/BD_Analysis/{j}/* {outdir}/{module_num}.BD_Analysis/{j} ', shell=True)
					if os.path.exists(f"{outdir}/{module_num}.BD_Analysis/{j}/{j}_final.BAM" ):
						subprocess.call(f'rm {outdir}/{module_num}.BD_Analysis/{j}/{j}_final.BAM*', shell=True)
					if os.path.exists(f"{outdir}/{module_num}.BD_Analysis/{j}/Logs/" ):
						subprocess.call(f'rm  -rf {outdir}/{module_num}.BD_Analysis/{j}/Logs', shell=True)
					print(os.path.exists(f"{outdir}/{module_num}.BD_Analysis/{j}/Logs/" ))
					## png
					#check_exist(
					#	file=f"BD_Analysis/{j}.png",
					#	destination= f"{outdir}/{module_num}.BD_Analysis/" ,
					#	log_file=log_file
					#)
				# aggr
				#if len(sample_name) > 1 :
				#	if not os.path.exists("cellranger/aggr" ):
				#		logging_exit("[cellranger module] Can not find CellRanger Aggr results!",log_file)
				#	else:
				#		os.makedirs(f"{outdir}/{module_num}.CellRanger/aggr")
				#		subprocess.call(f'ln -s {program_path}/cellranger/aggr/outs/* {outdir}/{module_num}.CellRanger/aggr ', shell=True)
				#		subprocess.call(f'rm  {outdir}/{module_num}.CellRanger/aggr/aggregation.csv ', shell=True)
	## ========================= 1.2 Count_QC =========================

	if not os.path.exists("Count_QC"):
		logging("[Count_QC module] × ",log_file,WARNING)
	else:
		module_num += 1
		logging("[Count_QC module] √ ",log_file)
		os.makedirs(f'{outdir}/{module_num}.Count_QC'),
		## test 3
		check_file_num(f"Count_QC", f"{outdir}/{module_num}.Count_QC/",6,log_file)

	## ========================= 1.3 Clustering ========================= 
	if not os.path.exists("Clustering" ):
		logging("[Clustering module] × ",log_file,WARNING) 
	else:
		module_num += 1
		logging("[Clustering module] √ ",log_file) 
		os.makedirs(f'{outdir}/{module_num}.Clustering/')
		reduct1 = config['report_params']['reduct1']
		reduct2 = config['report_params']['reduct2']
		# clustering 
		check_exist(file="Clustering/clustering_results.csv",
			destination=f'{outdir}/{module_num}.Clustering/',
			log_file= log_file)
		# reduct1
		if reduct1 == "mnn":
			check_exist(file="Clustering/sampleid-batchid.xls" ,
				destination=f'{outdir}/{module_num}.Clustering/',
				log_file= log_file)
		check_file_num(f"Clustering/{reduct2}_Dimension_Reduction", f"{outdir}/{module_num}.Clustering/",3,log_file)
		# check_exist(file="%s/Clustering/%s_Dimension_Reduction"  % (program_path,reduct2),
		# 	destination='%s/%s.Clustering/' % (outdir, module_num),
		# 	log_file= log_file)
		## visualize
		if len(sample_name) >1 :
			check_exist(file="Clustering/visualize_cluster_by_clusters",
				destination=f'{outdir}/{module_num}.Clustering/',
				log_file= log_file)
		### correlation
		#check_exist(file="Clustering/clusters_correlation",
		#	destination=f'{outdir}/{module_num}.Clustering/',
		#	log_file= log_file)
		module_num += 1
		#os.makedirs("%s/%s.clusters_correlation" % (outdir, module_num))
		# subprocess.call('cp -r %s/result/Clustering/clusters_correlation/* %s/%s.clusters_correlation/' % (program_path, outdir, module_num), shell=True)
		os.makedirs(f"{outdir}/{module_num}.Clusters_correlation/" )
		subprocess.call(f'cp -r Clustering/clusters_correlation/{{*.xls,*.pdf,*.png}} {outdir}/{module_num}.Clusters_correlation/', shell=True)
		# check_exist(file="Clustering/clusters_correlation",
			# destination=f'{outdir}/{module_num}.Clustering/',
			# log_file= log_file)
	## ========================= 1.4 Marker =========================  
	if not os.path.exists("Marker" ):
		logging("[Marker module] × ",log_file,WARNING) 
	else:
		module_num += 1
		logging("[Marker module] √ ",log_file) 
		# os.makedirs("%s/%s.Marker/" % (outdir, module_num))
		os.makedirs(f"{outdir}/{module_num}.Marker/top10_markers_visualize_for_each_cluster" )
		check_file_num("Marker/", f"{outdir}/{module_num}.Marker/",6,log_file)
		# move content check here?
		subprocess.call(f'cp -r Marker/markers_vis4cluster* {outdir}/{module_num}.Marker/top10_markers_visualize_for_each_cluster/', shell=True)
		subprocess.call(f'rm {outdir}/{module_num}.Marker/top10_markers_for_each_cluster.xls {outdir}/{module_num}.Marker/all_markers_for_each_cluster.xls' , shell=True)
		# os.makedirs("%s/%s.Marker/top10_markers_visualize_for_each_cluster" % (outdir, module_num))
		# subprocess.call('cp -r  %s/Marker/markers_vis4cluster* %s/%s.Marker/top10_markers_visualize_for_each_cluster/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp -r  %s/Marker/topmarker_gene_heatmap.p* %s/%s.Marker/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp -r  %s/Marker/top10_markers_for_each_cluster_anno.xls %s/%s.Marker/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp -r  %s/Marker/all_markers_for_each_cluster_anno.xls %s/%s.Marker/' % (program_path, outdir, module_num), shell=True)
	## ========================= 1.5 Reference_celltype =========================   
	if not os.path.exists("Reference_celltype" ):
		logging("[Reference_celltype module] × ",log_file,WARNING) 
	else:
		module_num += 1
		logging("[Reference_celltype module] √ ",log_file) 
		os.makedirs(f"{outdir}/{module_num}.Reference_celltype" )
		check_file_num("Reference_celltype/", f"{outdir}/{module_num}.Reference_celltype/",9,log_file)
		#subprocess.call('cp %s/Reference_celltype/* %s/%s.Reference_celltype/' % (program_path, outdir, module_num), shell=True)
	## ========================= 1.6 Diffexp =========================  
	if not os.path.exists("Diffexp" ):
		logging("[Diffexp module] × ",log_file,WARNING) 
	else:
		module_num += 1
		logging("[Diffexp module] √ ",log_file) 
		os.makedirs(f"{outdir}/{module_num}.Diffexp")
		# read in diffexp.tsv
		if os.path.exists("../"+config["report_params"]["diffexp_file"]):
			diff_groups = pd.read_table("../"+config["report_params"]["diffexp_file"], dtype=str)
			ndiffexp = diff_groups.shape[0]
		else: 
			ndiffexp = int(input("未找到diffexp.tsv表格，请输入差异组数："))
		check_file_num(f"Diffexp/", f"{outdir}/{module_num}.Diffexp/",1+7*ndiffexp,log_file)
		subprocess.call(f'rm {outdir}/{module_num}.Diffexp/*-vs-*-diff-pval-0.05-FC-1.5.xls {outdir}/{module_num}.Diffexp/*-vs-*-all_diffexp_genes.xls', shell=True)
		# subprocess.call('cp %s/Diffexp/diffexp_results_stat.xls %s/%s.Diffexp/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp %s/Diffexp/*-vs-*-diff-*_anno.xls %s/%s.Diffexp/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp %s/Diffexp/*-vs-*-all_diffexp_genes_anno.xls %s/%s.Diffexp/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp %s/Diffexp/top*-vs-*_genes.xls %s/%s.Diffexp/' % (program_path, outdir, module_num), shell=True)
		# subprocess.call('cp %s/Diffexp/*_heatmap.p* %s/%s.Diffexp/' % (program_path, outdir, module_num), shell=True)
		if os.path.exists("Diffexp/FC1.2" ):
			logging("[Diffexp FC1.2 module] √ ",log_file)
			os.makedirs(f"{outdir}/{module_num}.Diffexp/FC1.2")
			subprocess.call(f'cp -r Diffexp/FC1.2/ {outdir}/{module_num}.Diffexp/', shell=True)
			subprocess.call(f'rm -rf {outdir}/{module_num}.Diffexp/FC1.2/enrichment/enrichment_sh/', shell=True)
		## ========================= 1.7 enrichment =========================  
		if not os.path.exists("Diffexp/enrichment"):
			logging_exit("[enrichment module] × ",log_file,WARNING) 
		else:
			logging("[enrichment module] √ ",log_file)
			module_num += 1
			os.makedirs(f"{outdir}/{module_num}.enrichment")
			subprocess.call(f'cp -r Diffexp/enrichment/GO_enrichment/ {outdir}/{module_num}.enrichment/', shell=True)
			subprocess.call(f'cp -r Diffexp/enrichment/KEGG_enrichment/ {outdir}/{module_num}.enrichment/', shell=True)
			if not len(os.listdir(f"{outdir}/{module_num}.enrichment/GO_enrichment")) == ndiffexp + 1:
				logging(f"GO_enrichment 目录下 {len(os.listdir(f'{outdir}/{module_num}.enrichment/GO_enrichment'))} 个文件，应有 {ndiffexp + 1} 个文件! 请核查!!!",log_file,WARNING)
			else:
				for i in glob(f"{outdir}/{module_num}.enrichment/GO_enrichment/*-vs-*/"):
					if len(os.listdir(i)) != 23:
						logging(f"GO_enrichment 目录下 {str(i).split('GO_enrichment/')[-1]} 分组有 {len(os.listdir(i))} 个文件，应有 23 个文件! 请核查!!!",log_file,WARNING)
			if not len(os.listdir(f"{outdir}/{module_num}.enrichment/KEGG_enrichment")) == ndiffexp + 1:
				logging(f"KEGG_enrichment 目录下 {len(os.listdir(f'{outdir}/{module_num}.enrichment/KEGG_enrichment'))} 个文件，应有 {ndiffexp + 1} 个文件! 请核查!!!",log_file,WARNING)
			else:
				for i in glob(f"{outdir}/{module_num}.enrichment/KEGG_enrichment/*-vs-*/"):
					if len(os.listdir(i)) != 23:
						logging(f"KEGG_enrichment 目录下 {str(i).split('KEGG_enrichment/')[-1]} 分组有 {len(os.listdir(i))} 个文件，应有 23 个文件! 请核查!!!",log_file,WARNING)
		## ========================= 1.8 PPI =========================  
		if not os.path.exists("Diffexp/ppi" ):
			logging("[ppi module] × ",log_file,WARNING) 
		else: 
			logging("[ppi module] √ ",log_file)
			module_num += 1
			os.makedirs(f"{outdir}/{module_num}.ppi")
			check_file_num("Diffexp/ppi", f"{outdir}/{module_num}.ppi",ndiffexp*8+6,log_file)
			subprocess.call(f'rm {outdir}/{module_num}.ppi/color_table.tsv', shell=True)
			subprocess.call(f'rm {outdir}/{module_num}.ppi/*-top25.tsv', shell=True)
			subprocess.call(f'rm -f {outdir}/{module_num}.ppi/*mapping_results.tsv', shell=True)
			subprocess.call(f'rm -f {outdir}/{module_num}.ppi/*ppi_network.tsv', shell=True)
			# subprocess.call('cp %s/Diffexp/ppi/*string_protein-protein-interaction.* %s/%s.Diffexp/ppi/' % (program_path, outdir, module_num), shell=True)

	## ========================= 1.9 others =========================
	#subprocess.call(f'cp -r {scriptdir}/supplemental_material {outdir}', shell=True)
	## ========================= 1.9 others =========================
	module_num += 1
	os.makedirs(f"{outdir}/{module_num}.supplemental_material")
	subprocess.call(f'cp -r {scriptdir}/supplemental_material/{{*.pdf,*.html}} {outdir}/{module_num}.supplemental_material/', shell=True)
	supp_dir = f"{module_num}.supplemental_material"
	## ========================= rds transfer =========================
	if not (rds is None):
		rds_file = os.path.join(orig_path,rds)
		if os.path.isfile(rds_file):
			os.system("ssh scrna@192.168.10.24 mkdir /oecloud/userfiles/%s" %(program_num))
			if ( os.system("scp %s scrna@192.168.10.24:/oecloud/userfiles/%s/" %(rds_file, program_num)) != 0 ):
				logging_exit("[rds transfer] × Fails to transfer rds file. Please check your network and transfer again.",log_file,WARNING)
			else:
				logging(f"[rds transfer] √ {rds} uploaded successfully. V3 rds will be removed.",log_file)
				subprocess.call(f'rm {rds_file}', shell=True)
		else:
			logging_exit(f"[rds transfer] × Couldn't find {rds} file! Please check the file path.",log_file,WARNING)
	# log_file.close()
####################################################################################################
## ========================= 二、2.Generate report =========================
####################################################################################################
	os.chdir(outdir)
	logging("____2. Generating Report..._____",log_file)
	# Define header info
	header_info = {key: config["report"][key] for key in config["report"] if
               key in ["Project_Num", "Customer", "Species", "Executor", "Sample_Num", "Task_Num"]}
	header_info["项目编号"] = header_info.pop("Project_Num")
	header_info["客户姓名"] = header_info.pop("Customer")
	header_info["实验物种"] = header_info.pop("Species")
	header_info["执行编号"] = header_info.pop("Executor")
	header_info["样本数目"] = header_info.pop("Sample_Num")
	header_info["任务单号"] = header_info.pop("Task_Num")
	if vdj_type !="mRNA":
		if vdj_type=="dan":
			report_name = "BD单细胞转录组和表面蛋白项目结题报告"
			report_title = "BD单细胞转录组和表面蛋白项目结题报告"
		else :
			report_name = "BD单细胞转录组和免疫组项目结题报告"
			report_title = "BD单细胞转录组和免疫组项目结题报告"
	else :
		report_name = "BD单细胞转录组项目结题报告"
		report_title = "BD单细胞转录组项目结题报告"
	report = Report(report_name, title = report_title, header_info = dict(header_info), oe_welcome='''
	
####  感谢您选择欧易生物！

**关于网页报告使用有以下几点提示:**

1. **报告正文**中的**蓝色字体**均可以**点击**快速导引到感兴趣的章节，便于您快速查看相应内容。
2. **报告正文**中的**图片**均可以点击后进行**放大查看**，且图片点击后可以包含更多的细节信息，比如左上角会显示具体的**图片数量**，右上角有相关的**图片工具**，**键盘上的左右方向键/鼠标滚轮**可以对图片进行**切换**。
3. **报告正文**中**每个区域**中图片的数量**最多**只显示2张，更多的图片可以在点击之后在弹出界面利用**键盘方向键/鼠标滚轮**查看。
4. 展示的表格均可以在各列**表头**进行**升序或者降序显示**，当表格多于20行的时候，表格会嵌入到网页之中，可以利用滚动栏进行调整设置，同时会在表格上方增加搜索设置，便于快速查询表格信息。
5. 在报告中浏览，需要返回顶部的时候，可以使用网页**右下角的白色箭头标识**快速返回顶部。
6. 本提示可以点击右上方的不再显示，则后续打开网页均不会显示本提示。
	''')
	report.add_yaml_config(os.path.join(scriptdir, 'bd_report.yaml'))
	os.environ['OEBIO'] = os.path.join(scriptdir,"pic")
	os.environ['oeweb_register_token'] = 'oearray'
	## test
	# project_module1 = report.add_section('项目概况')
	# project_module2 = report.add_section('项目概况')
	# project_module2.add_comment("comment1")
	# project_module1.add_comment("comment2")
	# report.write_to('report.html')
	# sys.exit()
	############################################################################
	## ========================= 2.1 SECTION1 项目概况 ========================= 
	############################################################################
	project_module = report.add_section('项目概况')
	register_info = oeweb_register(project_id=program_num, target_url='https://cloud.oebiotech.cn/task/category/scrna', note='本报告包含项目基本分析内容，如需快速做细胞表达可视化等分析(数据默认保留半年)')
	if register_info:
		project_module.add_comment(register_info)
	# move to the end
	report_summary_list = []
	report_hyperlink_list = []
	###############################################################################
	## ========================= 2.2 SECTION2 实验技术流程 ========================= 
	###############################################################################
	## ========================= 2.2.1 建库测序流程 =========================  
	library_module = report.add_section('实验技术流程')
	library_module.add_comment('实验建库测序流程图如下：')
	library_module.add_plot('Experiment.png',caption ='建库测序流程图',content='建库测序流程图')
	
	###############################################################################
	## ========================= 2.3 SECTION3 生信分析流程 ========================= 
	###############################################################################
	analysis_module = report.add_section('生信分析流程')
	analysis_module.add_comment('生物信息分析流程图如下：')
	analysis_module.add_plot('Pipeline.png', caption = '生物信息分析流程',content='生物信息分析流程图')
	###############################################################################
	## ========================= 2.4 SECTION4 项目分析结果 ========================= 
	###############################################################################
	result_module = report.add_section('项目分析结果')
	
	## ========================= 2.4.1 基因定量质控 =========================  
	if len(list(glob("*.BD_Analysis"))) != 0:
		report_hyperlink_list.append('[样本 BD WAT 质控结果](#cellranger)\n\n')
		Cellranger = result_module.add_section('基因定量质控')
		Cellranger.add_table("../../BD_Analysis/metrics_summary_stat.csv", caption = '样本细胞质量统计结果')
		Cellranger.add_table('../../../scripts/report_BD/pic/tables/scRNA_qc_stat.txt', caption = '样本细胞质量统计结果说明')
		
	## ========================= 2.4.2 定量后质控 ========================= 
	if len(list(glob("*.Count_QC"))) != 0:
		QC_folder = list(glob(r"[0-9]*.Count_QC"))[0]
		Count_QC = result_module.add_section('定量后质控')
		#nGene_nUMI_fold2sd = int(config['report_params']['ngene_numi_fold2sd'])
		summ = pd.read_csv(f'{QC_folder}/cell_statitics_before_after_QC.xls',index_col=0,sep='\t')
		mito =  'percent.mito_higher' in summ.columns
		HB =  'percent.HB_higher' in summ.columns
		rmdoublet = 'mean_nFeature_RNA_after_rmdoublets' in summ.columns
		cut_1 = config['report_params']['cut1']
		cut_2 = config['report_params']['cut2']
		cut_method = {'median':'中位值','mean':'平均值','sd':'标准差','mad':'绝对中位差'}	
		## summay 
		# if summ.shape[1] != (5+2*int(mito))*(2+int(rmdoublet))+2*(2+int(mito)) :
		try:
			nGene_nUMI_fold2sd = int(config['report_params']['ngene_numi_fold2sd'])
		except:
			if summ.shape[1] != (7+2*int(mito)+2*int(HB))*(2+int(rmdoublet))+2*(3+int(mito)+int(HB)) :
				sys.exit(f'Please check {QC_folder}/cell_statitics_before_after_QC.xls format.')
		else:
			if summ.shape[1] != (5+2*int(mito))*(2+int(rmdoublet))+2*(2+int(mito)) :
				sys.exit(f'Please check {QC_folder}/cell_statitics_before_after_QC.xls format.') 
		if rmdoublet: 
			lastQCstep="_rmdoublets" 
		else:
			lastQCstep="QC" 
		## check cell num
		# a = summ.apply(lambda r: (r["Total_cells_beforeQC"]-r[f"Total_cells_after{lastQCstep}"])/r["Total_cells_beforeQC"] > 0.2 ,axis=1)
		if min(summ['Total_cells_afterQC'])/max(summ[f"Total_cells_after{lastQCstep}"]) <= 0.5:
			logging("? Count_QC 中存在样本间细胞数相差>=2倍，请注意。",log_file,WARNING)
		for index,row in summ.iterrows():
			if (row["Total_cells_beforeQC"] - row[f"Total_cells_after{lastQCstep}"]) / row["Total_cells_beforeQC"] > 0.4 :
				logging(f"? Count_QC 中 {index} 样本过滤掉的细胞数目超过 40%，请注意。",log_file,WARNING)
		if summ.shape[0] > 1 :
			report_summary_list.append(f'''
本次分析共完成 {len(summ)} 个样本 BD单细胞转录组测序,
各样本定量质控的高质量细胞数分布在 {min(summ['Total_cells_beforeQC'])} ~ {max(summ['Total_cells_beforeQC'])} 个，
经剔除双细胞、多细胞和凋亡细胞等质控后，最终获得的细胞数目分布在 {min(summ['Total_cells_after'+lastQCstep]) } ~ {max(summ['Total_cells_after'+lastQCstep])} 个，
每个细胞中的平均 UMI 数分布在 {format(min(summ['mean_nCount_RNA_after'+lastQCstep].astype(float)),'.0f')} ~ {format(max(summ['mean_nCount_RNA_after'+lastQCstep].astype(float)),'.0f')}，
每个细胞中的平均基因数分布在 {format(min(summ['mean_nFeature_RNA_after'+lastQCstep].astype(float)),'.0f')} ~ {format(max(summ['mean_nFeature_RNA_after'+lastQCstep].astype(float)),'.0f')}''')
		else:
			report_summary_list.append(f'''
本次分析共完成 {len(summ)} 个样本 BD单细胞转录组测序,
各样本定量质控的高质量细胞数为 {max(summ['Total_cells_beforeQC'])} 个，
经剔除双细胞、多细胞和凋亡细胞等质控后，最终获得的细胞数目为 {max(summ['Total_cells_after'+lastQCstep])} 个，
每个细胞中的平均 UMI 数为 {format(max(summ['mean_nCount_RNA_after'+lastQCstep].astype(float)),'.0f')}，
每个细胞中的平均基因数为 {format(max(summ['mean_nFeature_RNA_after'+lastQCstep].astype(float)),'.0f')}''')
		if mito:
			percent_mito = int(float(max(summ["percent.mito_higher"])*100)) # # percent_mito = int(float(dict(config['report_params'])['percent_mito'])*100)
			mito_description=f'、线粒体UMI占比低于四倍UMI中位值'
			mito_show=f'、线粒体UMI所占比例（percent_mito）'
			# summary
			min_afterQC_mito = format(min(summ['mean_percent.mito_after'+lastQCstep].astype(float)),'.4f') # mito
			max_afterQC_mito = format(max(summ['mean_percent.mito_after'+lastQCstep].astype(float)),'.4f') 
			if summ.shape[0] > 1 :
				report_summary_list.append(f"，每个细胞中平均线粒体UMI占比分布在 {min_afterQC_mito} ~ {max_afterQC_mito}。")
			else :
				report_summary_list.append(f"，每个细胞中平均线粒体UMI占比为 {max_afterQC_mito}。")
		else: 
			mito_description=''
			mito_show=''
			report_summary_list.append(f"。")
		if HB:
			percent_HB = int(float(max(summ["percent.HB_higher"])*100))
			HB_description=f'、血红细胞基因占比低于 {percent_HB}%的细胞'
			HB_show=f'、血红细胞基因所占比例（percent_HB）'
		else: 
			HB_description=''
			HB_show=''
		if rmdoublet:
			rmdoublet_methods = dict(config['report_params'])['rmdoublets_methods']
			rmdoublet_description = f'''然后使用{rmdoublet_methods}[^DoubletFinder] 软件进行双细胞去除，进行下游分析。
            \n[^DoubletFinder]: Mcginnis C S , Murrow L M , Gartner Z J . DoubletFinder: Doublet detection in single-cell RNA sequencing data using artificial nearest neighbors. 2018.\n'''
		else:
			rmdoublet_description = '，进行下游分析。'
		if config['report_params']['roboust_linear_model'] is None:
			roboust_linear_model_description = f''
		else:
			roboust_linear_model_description = f'''理论上大部分细胞中表达的基因数量、UMI 数量和线粒体基因的表达量会集中分布在某一区域内，根据它们的分布特征可以拟合分布模型，使用该模型找到其中的离域值，剔除异常数据。'''
		try:
			nGene_nUMI_fold2sd = int(config['report_params']['ngene_numi_fold2sd'])
		except:
			QC_description = f'''在 BD WAT 初步质控的基础上进一步对实验数据进行质控，剔除多细胞、双细胞或者未结合上细胞的数据，进行下游分析。
\n本项目中的质控标准为：保留基因数大于 {format(min(summ['nFeature_RNA_lower'].astype(float)),'.0f')} 、UMI数大于 {format(min(summ['nCount_RNA_lower'].astype(float)),'.0f')}、log10GenesPerUMI大于 {min(summ['log10GenesPerUMI_lower'].astype(float))}{mito_description}{HB_description}作为高质量细胞{rmdoublet_description} 
\n质控前后每个细胞的基因数量（nGene）、UMI数量（nUMI）、单位UMI内基因数目的比例（log10GenesPerUMI）{mito_show}{HB_show}的小提琴图展示如下：
		'''
		else:
			QC_description = f'''在 BD WAT 初步质控的基础上进一步对实验数据进行质控，剔除多细胞、双细胞或者未结合上细胞的数据。{roboust_linear_model_description}
\n本项目中的质控标准为：保留细胞基因数和UMI数在{cut_method[cut_1]} ± {nGene_nUMI_fold2sd} 倍{cut_method[cut_2]}范围内{mito_description}的细胞作为高质量细胞{rmdoublet_description} 
\n质控前后每个细胞的基因数量（nGene）、UMI数量（nUMI）和线粒体UMI所占比例（percent_mito）的小提琴图展示如下：
        '''
		#Count_QC_sub1 = Count_QC.add_section('过滤低质量细胞', nGene_nUMI_fold2sd=nGene_nUMI_fold2sd, percent_mito=percent_mito,rmdoublet_methods=rmdoublet_methods)
		Count_QC_sub1 = Count_QC.add_section(name='过滤低质量细胞', description=QC_description)
		# 1.outliers
		Count_QC1_plots = list(glob('*.Count_QC/outliers.png'))
		if len(Count_QC1_plots) != 0:
			Count_QC1_contents = ['拟合广义线性模型过滤离域细胞图。图片说明：横轴为每个细胞内的 UMI 数，纵轴为每个细胞内的基因数，根据二者的线性关系拟合分布模型，着色的点表示离域细胞，在下游分析中会进行剔除。']
			Count_QC1_plots = list(zip(Count_QC1_plots, Count_QC1_contents))
			Count_QC_sub1.add_plot(Count_QC1_plots, 
				caption = '拟合广义线性模型过滤离域细胞图',
				description = '图片说明：横轴为每个细胞内的 UMI 数，纵轴为每个细胞内的基因数，根据二者的线性关系拟合分布模型，着色的点表示离域细胞，在下游分析中会剔除。')
		try:
			nGene_nUMI_fold2sd = int(config['report_params']['ngene_numi_fold2sd'])
		except:			
			if mito and HB:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）、线粒体基因比例（percent.mito）以及血红细胞基因比例（percent.HB）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , 
				   caption = '质控前每个细胞中各指标含量的小提琴分布图' , 
				   description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本的数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）、线粒体基因比例（percent.mito）以及血红细胞基因比例（percent.HB）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), 
				   caption = '质控后每个细胞中各指标含量的小提琴分布图' )
				#)
				# 4. cell counts
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
				headerdict={'sample':'样本名称',
					'Total_cells_beforeQC':'质控前的总细胞数',
					'Total_cells_afterQC':'质控后的总细胞数',
					'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
					'nFeature_RNA_min':'样本中基因数最低值',
					'nFeature_RNA_max':'样本中基因数最高值',
					'nCount_RNA_min':'样本中UMI数最低值',
					'nCount_RNA_max':'样本中UMI数最高值',
					'log10GenesPerUMI_min':'样本中log10GenesPerUMI最低值',
					'log10GenesPerUMI_max':'样本中log10GenesPerUMI最高值',
					'percent.mito_min':'样本中线粒体比例最低值',
					'percent.mito_max':'样本中线粒体比例最高值',
					'percent.HB_min':'样本中血红细胞比例最低值',
					'percent.HB_max':'样本中血红细胞比例最高值',
					},
				description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤；
\nlog10GenesPerUMI表示对应样本中单位UMI内基因数目的比例，反映数据的复杂度；
\npercent.mito反映样本中所有细胞线粒体基因在细胞所有基因中的占比，除特殊样本外，一般要求大部分细胞线粒体基因比例越低越好；
\npercent.HB反映样本中所有细胞血红细胞基因在细胞所有基因中的占比，除特殊样本外，一般要求大部分细胞血红细胞基因比例越低越好。''')
			elif mito and not HB:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）、线粒体基因比例（percent.mito）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , 
				  caption = '质控前每个细胞中各指标含量的小提琴分布图' , 
				  description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）、线粒体基因比例（percent.mito）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), 
				  caption = '质控后每个细胞中各指标含量的小提琴分布图' ,
				  description = '')
				# 4. cell counts
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
				headerdict={'sample':'样本名称',
					# 'mean_nFeature_RNA_beforeQC':'质控前细胞中的平均基因数',
					# 'median_nFeature_RNA_beforeQC':'质控前细胞中的基因数中位值',
					# 'mean_nCount_RNA_beforeQC':'质控前细胞中的平均UMI数',
					# 'median_nCount_RNA_beforeQC':'质控前细胞中的UMI数中位值',
					# 'mean_percent.mito_beforeQC':'质控前细胞中的平均线粒体比例',
					# 'median_percent.mito_beforeQC':'质控前细胞中的线粒体比例中位值',
					'Total_cells_beforeQC':'质控前的总细胞数',
					# 'mean_nFeature_RNA_afterQC':'质控后细胞中的平均基因数',
					# 'median_nFeature_RNA_afterQC':'质控后细胞中的基因数中位值',
					# 'mean_nCount_RNA_afterQC':'质控后细胞中的平均UMI数',
					# 'median_nCount_RNA_afterQC':'质控后细胞中的UMI数中位值',
					# 'mean_percent.mito_afterQC':'质控后细胞中的平均线粒体比例',
					# 'median_percent.mito_afterQC':'质控后细胞中的线粒体比例中位值',
					'Total_cells_afterQC':'质控后的总细胞数',
					'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
					'nFeature_RNA_min':'样本中基因数最低值',
					'nFeature_RNA_max':'样本中基因数最高值',
					'nCount_RNA_min':'样本中UMI数最低值',
					'nCount_RNA_max':'样本中UMI数最高值',
					'log10GenesPerUMI_min':'样本中log10GenesPerUMI最低值',
					'log10GenesPerUMI_max':'样本中log10GenesPerUMI最高值',
					'percent.mito_min':'样本中线粒体比例最低值',
					'percent.mito_max':'样本中线粒体比例最高值',
					# 'mean_nFeature_RNA_after_rmdoublets':'去除双细胞后细胞中的平均基因数',
					# 'median_nFeature_RNA_after_rmdoublets':'去除双细胞后细胞中的基因数中位值',
					# 'mean_nCount_RNA_after_rmdoublets':'去除双细胞后细胞中的平均UMI数',
					# 'median_nCount_RNA_after_rmdoublets':'去除双细胞后细胞中的UMI数中位值',
					# 'mean_percent.mito_after_rmdoublets':'去除双细胞后细胞中的平均线粒体比例',
					# 'median_percent.mito_after_rmdoublets':'去除双细胞后细胞中的线粒体比例中位值',
					},
				description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤；
\nlog10GenesPerUMI表示对应样本中单位UMI内基因数目的比例，反映数据的复杂度；
\npercent.mito反映样本中所有细胞线粒体基因在细胞所有基因中的占比，除特殊样本外，一般要求大部分细胞线粒体基因比例越低越好。''')

			elif HB and not mito:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）以及血红细胞基因比例（percent.HB）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , 
				  caption = '质控前每个细胞中各指标含量的小提琴分布图' , 
				  description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目（nFeature_RNA）、UMI数目即转录本数目（nCount_RNA）、log10GenesPerUMI值（log10GenesPerUMI）以及血红细胞基因比例（percent.HB）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), 
				  caption = '质控后每个细胞中各指标含量的小提琴分布图' ,
				  description = '')
				# 4. cell counts
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
				headerdict={'sample':'样本名称',
					'Total_cells_beforeQC':'质控前的总细胞数',
					'Total_cells_afterQC':'质控后的总细胞数',
					'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
					'nFeature_RNA_min':'样本中基因数最低值',
					'nFeature_RNA_max':'样本中基因数最高值',
					'nCount_RNA_min':'样本中UMI数最低值',
					'nCount_RNA_max':'样本中UMI数最高值',
					'log10GenesPerUMI_min':'样本中log10GenesPerUMI最低值',
					'log10GenesPerUMI_max':'样本中log10GenesPerUMI最高值',
					'percent.HB_min':'样本中血红细胞比例最低值',
					'percent.HB_max':'样本中血红细胞比例最高值',
					},
				description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤；
\nlog10GenesPerUMI表示对应样本中单位UMI内基因数目的比例，反映数据的复杂度；
\npercent.HB反映样本中所有细胞血红细胞基因在细胞所有基因中的占比，除特殊样本外，一般要求大部分细胞血红细胞基因比例越低越好。''')
			else:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目（左）、UMI数目即转录本的数目（中）以及log10GenesPerUMI值（右）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , 
				  caption = '质控前每个细胞中各指标含量的小提琴分布图' , 
				  description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目（左）、UMI数目即转录本的数目（中）以及log10GenesPerUMI值（右）的小提琴分布图。图中每个点代表一个细胞。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), 
				  caption = '质控后每个细胞中各指标含量的小提琴分布图' ,
				  description = '')
				# 4. cell counts
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
				headerdict={'sample':'样本名称',
					'Total_cells_beforeQC':'质控前的总细胞数',
					'Total_cells_afterQC':'质控后的总细胞数',
					'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
					'nFeature_RNA_min':'样本中基因数最低值',
					'nFeature_RNA_max':'样本中基因数最高值',
					'nCount_RNA_min':'样本中UMI数最低值',
					'nCount_RNA_max':'样本中UMI数最高值',
					'log10GenesPerUMI_min':'样本中log10GenesPerUMI最低值',
					'log10GenesPerUMI_max':'样本中log10GenesPerUMI最高值',
					},
				description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤；
\nlog10GenesPerUMI表示对应样本中单位UMI内基因数目的比例，反映数据的复杂度。''')
		else:
			if mito:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目、UMI数目以及线粒体UMI占比的小提琴分布图。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , caption = '质控前每个细胞中各指标含量的小提琴分布图' , description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目、UMI数目以及线粒体UMI占比的小提琴分布图。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), caption = '质控后每个细胞中各指标含量的小提琴分布图' , description = '')
				# 4. cell counts	
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
                                headerdict={'sample':'样本名称',
                                        # 'mean_nFeature_RNA_beforeQC':'质控前细胞中的平均基因数',
                                        # 'median_nFeature_RNA_beforeQC':'质控前细胞中的基因数中位值',
                                        # 'mean_nCount_RNA_beforeQC':'质控前细胞中的平均UMI数',
                                        # 'median_nCount_RNA_beforeQC':'质控前细胞中的UMI数中位值',
                                        # 'mean_percent.mito_beforeQC':'质控前细胞中的平均线粒体比例',
                                        # 'median_percent.mito_beforeQC':'质控前细胞中的线粒体比例中位值',
                                        'Total_cells_beforeQC':'质控前的总细胞数',
                                        # 'mean_nFeature_RNA_afterQC':'质控后细胞中的平均基因数',
                                        # 'median_nFeature_RNA_afterQC':'质控后细胞中的基因数中位值',
                                        # 'mean_nCount_RNA_afterQC':'质控后细胞中的平均UMI数',
                                        # 'median_nCount_RNA_afterQC':'质控后细胞中的UMI数中位值',
                                        # 'mean_percent.mito_afterQC':'质控后细胞中的平均线粒体比例',
                                        # 'median_percent.mito_afterQC':'质控后细胞中的线粒体比例中位值',
                                        'Total_cells_afterQC':'质控后的总细胞数',
                                        'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
                                        'nFeature_RNA_lower':'基因数过滤标准最低值',
                                        'nFeature_RNA_higher':'基因数过滤标准最高值',
                                        'nCount_RNA_lower':'UMI数过滤标准最低值',
                                        'nCount_RNA_higher':'UMI数过滤标准最高值',
                                        'percent.mito_lower':'线粒体比例过滤标准最低值',
                                        'percent.mito_higher':'线粒体比例过滤标准最高值',
                                        # 'mean_nFeature_RNA_after_rmdoublets':'去除双细胞后细胞中的平均基因数',
                                        # 'median_nFeature_RNA_after_rmdoublets':'去除双细胞后细胞中的基因数中位值',
                                        # 'mean_nCount_RNA_after_rmdoublets':'去除双细胞后细胞中的平均UMI数',
                                        # 'median_nCount_RNA_after_rmdoublets':'去除双细胞后细胞中的UMI数中位值',
                                        # 'mean_percent.mito_after_rmdoublets':'去除双细胞后细胞中的平均线粒体比例',
                                        # 'median_percent.mito_after_rmdoublets':'去除双细胞后细胞中的线粒体比例中位值',
                                        },
                                        description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转
录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤''')
			else:
				# 2.before 
				before_plots = list(glob('*.Count_QC/QC_metrics_beforeQC.png'))
				before_contents = ['质控前每个细胞中基因表达数目、UMI数目的小提琴分布图。']
				Count_QC_sub1.add_plot( list(zip(before_plots,before_contents)) , 
                                     caption = '质控前每个细胞中各指标含量的小提琴分布图', description = '')
				# 3. after
				after_plots = list(glob('*.Count_QC/QC_metrics_afterQC.png'))
				after_contents = ['质控后每个细胞中基因表达数目、UMI数目的小提琴分布图。']
				Count_QC_sub1.add_plot(list(zip(after_plots, after_contents)), 
                                   caption = '质控后每个细胞中各指标含量的小提琴分布图' ,
                                   description = '')
				# 4. cell counts
				Count_QC_sub1.add_comment("定量质控前后的细胞数统计情况及过滤标准如下表所示：")
				Count_QC_sub1.add_table('*.Count_QC/cell_count_before_after_QC.xls', caption = '质控前后细胞数目统计表',
                                headerdict={'sample':'样本名称',
                                        'Total_cells_beforeQC':'质控前的总细胞数',
                                        'Total_cells_afterQC':'质控后的总细胞数',
                                        'Total_cells_after_rmdoublets':'过滤双细胞后的总细胞数',
                                        'nFeature_RNA_lower':'基因数过滤标准最低值',
                                        'nFeature_RNA_higher':'基因数过滤标准最高值',
                                        'nCount_RNA_lower':'UMI数过滤标准最低值',
                                        'nCount_RNA_higher':'UMI数过滤标准最高值',
                                        },
                                description = '''nFeature_RNA、nCount_RNA反映样本细胞中表达基因的数目/转录本数目，基因数目或转
录本数目异常过多的细胞很可能是由于对应的油包水微滴中包含多个细胞，需要通过设置合理的阈值将其过滤''')
	## ========================= 2.4.3 降维与聚类分析 ========================= 
	if len(list(glob("*.Clustering"))) != 0:
		# if os.path.exists("%s/Clustering/pca_Dimension_Reduction"  % (program_path)):
		# 	reduct1 = "PCA(Principal Components Analysis, 主成分分析)"
		# 	if os.path.exists("%s/Clustering/mnn_Dimension_Reduction"  % (program_path)):
		# 		sys.exit("ERROR! Both pca and mnn results found, please specify!")
		# elif os.path.exists("%s/Clustering/mnn_Dimension_Reduction"  % (program_path)):
		# 	reduct1 = "MNN(mutual nearest neighbors, 互享最近邻)"
		# if os.path.exists("%s/Clustering/tsne_Dimension_Reduction"  % (program_path)):
		# 	reduct2 = "t-SNE"
		# elif os.path.exists("%s/Clustering/umap_Dimension_Reduction"  % (program_path)):
		# 	reduct2 = "UMAP"
		report_hyperlink_list.append('[降维聚类分群结果](#cluster_resluts)\n\n[细胞群间相似性分析](#clusters_correlation)\n\n')
		Clustering_folder = list(glob(r"[0-9]*.Clustering"))[0]
		Clustering_module = result_module.add_section('降维与聚类分析', nav_emphasize = True, nav_title = "项目核心内容")
		reduct_module = Clustering_module.add_section('降维聚类结果')
		if reduct2 == "tsne": 
			REDUCT2 = "t-SNE（t-distributed Stochastic Neighbor Embedding, t-分布邻域嵌入）"
			Reduct2 = "t-SNE"  
		else: 
			REDUCT2="UMAP（统一流形逼近与投影）" # "UMAP 主要基于流形理论和拓扑算法的理论，对高维数据进行降维，从而能够保留更多数据的全局结构，并且具有优越的运行性能。"
			Reduct2 = "UMAP"
		if reduct1 == "pca":
			REDUCT1 = "PCA（Principal Components Analysis, 主成分分析）"
			reduct_module.add_comment(f'''本项目中采用的降维算法为 {REDUCT1} 和 {REDUCT2} 算法。基于 {reduct1.upper()} 的降维结果通过 {reduct2.upper()} 对单细胞群聚类进行可视化，聚类算法采用SNN，最终获得最优细胞分群。''')
		else:
			REDUCT1 = "MNN（mutual nearest neighbors, 互享最近邻）" 
			reduct_module.add_comment(f'''由于本项目不同样本间存在批次，首先采用了{REDUCT1} 的降维算法剔除批次效应，再基于 {reduct1.upper()} 的降维结果通过 {REDUCT2} 算法对单细胞群聚类进行可视化，聚类算法采用SNN，最终获得最优细胞分群。''')
		reduct_module.add_comment(f'''细胞分群的多少可以通过resolution参数的设定进行调整，后期可以根据细胞类型鉴定等，确定是否需要进行分群的调整。一般情况下，默认resolution=0.4。''')
		# 1.plot
		reduct_plots = list(glob('*.Clustering/*_groupby_cluster_resolution*_plot.png'))
		reduct_contents = ['降维聚类结果图。图片说明：横纵坐标分别代表降维的第一和第二主成分，图中的每个点代表一个细胞，不同群的细胞以不同颜色区分。']
		reduct_module.add_plot(list(zip(reduct_plots, reduct_contents)), 
			caption = '降维聚类结果图',
			description ='图片说明：横纵坐标分别代表降维的第一和第二主成分，图中的每个点代表一个细胞，不同群的细胞以不同颜色区分。')
		# 2. coor
		coordination_table = list(glob('*.Clustering/*_Dimension_Reduction_coordination.csv'))[0]
		link = get_url(Clustering_folder, str(coordination_table).split('/')[-1])   ####
		reduct_module.add_comment('降维聚类二维坐标表格见：')
		reduct_module.add_comment("{link}",link=link)
		# 3.batch
		if reduct1 == "mnn":
			Clustering_module.add_comment("样本所属批次情况如下表所示：")
			Clustering_module.add_table('*.Clustering/sampleid-batchid.xls', caption = '样本所属批次情况表',
				headerdict={'sampleid':'样本名称','batchid':'批次信息',})
		#reduct_3dplot = list(glob('*.Clustering/*_resolution*_3D_plot.html'))[0]
		#reduct_3dplot_link= get_url(Clustering_folder, str(reduct_3dplot).split('/')[-1])
		#reduct_3dplot_c = reduct_module.add_comment('降维聚类 3D 展示图见：')
		#reduct_3dplot_c2 = reduct_module.add_comment("{reduct_3dplot_link}",reduct_3dplot_link=reduct_3dplot_link)
		#reduct_3dplot_2 = reduct_module.add_plot('3D_plot.png', caption = '降维聚类 3D 示例图',content='降维聚类 3D 示例图', description ='图片说明：降维聚类 3D 展示图为交互式网页界面，可以使用鼠标自由拖动、缩放，查看三维状态下任一角度的降维聚类结果，点击右上角的相机按钮即可保存图片。')
		 
		if os.path.exists(f"{Clustering_folder}/visualize_cluster_by_clusters" ):
			groupby_module = Clustering_module.add_section('样本间降维聚类分组展示')
			groupby_plots = list(glob('*.Clustering/visualize_cluster_by_clusters/groupby-sampleid_contrast_plot.png' ))
			groupby_contents = ['多样本降维聚类分组展示图。图片说明：横纵坐标分别代表降维的第一和第二主成分，不同样本来源的细胞以不同颜色区分。']
			groupby_plots = list(zip(groupby_plots, groupby_contents))
			groupby_module.add_plot(groupby_plots, caption = '样本间降维聚类分组展示图', description ='图片说明：横纵坐标分别代表降维的第一和第二主成分，不同样本来源的细胞以不同颜色区分。')

			groupby_module.add_comment('每个细胞群中样本占比的柱状统计图如下：')
			groupby_plots3 = list(glob('*.Clustering/visualize_cluster_by_clusters/groupby-clusters_summary_plot.png'))
			groupby_contents = ['细胞群样本占比柱状图。图片说明：横坐标表示不同细胞群，纵坐标表示不同组别中细胞数目所占的百分比，每个Cluster中各样本来源细胞占比图，可以反映各样本中细胞分布的差异。']
			groupby_plots3 = list(zip(groupby_plots3, groupby_contents))
			groupby_module.add_plot(groupby_plots3, caption = '细胞群样本占比柱状图', description ='图片说明：横坐标表示不同细胞群，纵坐标表示不同组别中细胞数目所占的百分比，每个Cluster中各样本来源细胞占比图，可以反映各样本中细胞分布的差异。')

			groupby_module.add_comment('多个样本的降维聚类分面展示图如下：')
			groupby_plots2 = list(glob('*.Clustering/visualize_cluster_by_clusters/splitby-sampleid_split_plot.png' ))
			groupby_contents = ['多样本降维聚类分面展示图。图片说明：横纵坐标分别代表降维的第一和第二主成分，不同群的细胞以不同颜色区分。']
			groupby_plots2 = list(zip(groupby_plots2, groupby_contents))
			groupby_module.add_plot(groupby_plots2, caption = '多样本降维聚类分面展示图', description ='图片说明：横纵坐标分别代表降维的第一和第二主成分，不同群的细胞以不同颜色区分。')

			groupby_module.add_comment('每个样本中细胞群占比的柱状统计图如下：')
			groupby_plots4 = list(glob('*.Clustering/visualize_cluster_by_clusters/groupby-sampleid_summary_plot.png' ))
			groupby_contents = ['样本间细胞群占比柱状图。图片说明：横坐标表示不同样本，纵坐标表示不同组别中细胞数目所占的百分比。']
			groupby_plots4 = list(zip(groupby_plots4, groupby_contents))
			groupby_module.add_plot(groupby_plots4, caption = '样本间细胞群占比柱状图', description ='图片说明：横坐标表示不同样本，纵坐标表示不同组别中细胞数目所占的百分比。每个样本/分组中，各cluster来源细胞的比例图，可以反映两个信息：1）同一个组的不同重复样本是否一致；2）各cluster在组间的差异。此外，如果样本间细胞数差异比较大的情况，建议用如上柱状图，通过比例（而非细胞数）来分析差异性。')

			groupby_module.add_comment("各样本在不同细胞群中的细胞数目统计表如下：")
			groupby_module.add_table('*.Clustering/visualize_cluster_by_clusters/clust_cond_freq_info.xls', caption = '样本间细胞群数目统计表', headerdict={'sampleid':'样本名称','clusters':'细胞群编号','cell_number':'细胞数目','freq':'该样本在当前细胞群的细胞数占该样本所有细胞数的百分比'})
		
			link = get_url(Clustering_folder,'visualize_cluster_by_clusters')
			groupby_module.add_comment("详细结果目录见 : ")
			groupby_module.add_comment("{link}",link=link)
	
		## ========================= 2.4.4 细胞群间相似性分析 ========================= 
		Clusters_correlation_module = result_module.add_section('细胞群间相似性分析')
		Clusters_correlation_folder = list(glob("*.Clusters_correlation"))[0]
		Clusters_correlation_plots = list(glob('*.Clusters_correlation/coefficient_heatmap.png'))
		Clusters_correlatio_contents = ['细胞群间相关性热图。图片说明：横纵坐标为不同细胞群，热图中的数字为皮尔森相关性系数值。该值越大，热图颜色越红，表示细胞群之间的相关性程度越高。']
		Clusters_correlatio_plots2 = list(zip(Clusters_correlation_plots, Clusters_correlatio_contents))
		Clusters_correlation_module.add_plot(Clusters_correlatio_plots2, caption = '细胞群间相关性热图', description = '图片说明：横纵坐标为不同细胞群，图中的数字为皮尔森相关性系数。该值越大，热图颜色越红，表示细胞群之间的相关性程度越高。')
		
		Clusters_correlation_module.add_comment("各细胞群中的基因平均表达量表格见：")
		link = get_url(Clusters_correlation_folder,'normalized_data_groupby_clusters.xls')
		Clusters_correlation_module.add_comment("{link}",link=link)
		Clusters_correlation_module.add_comment("各细胞群中分样本的基因平均表达量表格见：")
		link = get_url(Clusters_correlation_folder,'normalized_data_groupby_sampleid_clusters.xls')
		Clusters_correlation_module.add_comment("{link}",link=link)
		correlation_results = pd.read_csv(f'{Clusters_correlation_folder}/normalized_data_groupby_clusters.xls', sep='\t')
		correlation_cluster_num = correlation_results.columns.size-1
	## ========================= 2.4.5 Marker基因鉴定 ========================= 
	if len(list(glob("*.Marker"))) != 0:
		report_hyperlink_list.append('[Marker 基因鉴定结果](#marker_results)\n\n')
		Marker_folder = list(glob(r"[0-9]*.Marker"))[0]
		Marker_file =  list(glob(f'{Marker_folder}/top10_markers_for_each_cluster_anno.xls'))[0]
		Marker_results = pd.read_csv(Marker_file, sep='\t')
		marker_cluster_num = max(Marker_results['cluster'])       #获取细胞群数
		report_summary_list.append(f'降维聚类后共分为 {marker_cluster_num} 群细胞')
		marker_test = dict(config['report_params'])['marker_test']
		# check cluster number
		if 'correlation_cluster_num' in locals() :
			if correlation_cluster_num != marker_cluster_num:
				logging_exit("× Marker 中的细胞群数与 Clusters_correlation 中的细胞群数不一致，请核查!!!" ,log_file)
			else: 
				logging("√ Marker 中的细胞群数与 Clusters_correlation 中的细胞群数一致。" ,log_file)
		else:
			logging("? Marker 目录下文件数一致，但未知与 Clusters_correlation 中的细胞群数关系，请先确定 Clusters_correlation 群数后再次核查!" ,log_file,WARNING)
		Marker_module = result_module.add_section('Marker基因鉴定', marker_test=marker_test, nav_emphasize = True, nav_title = "项目核心内容")

		link = list(glob(f'{Marker_folder}/all_markers_for_each_cluster_anno.xls'))[0]
		Marker_module.add_comment("每个细胞群中所有 Marker 基因结果表格：")
		Marker_module.add_comment("[{link}]({link})",link=link)
		link = list(glob(f'{Marker_folder}/top10_markers_for_each_cluster_anno.xls'))[0]
		Marker_module.add_plot('gene_diff.png',caption='gene_diff计算公式',description='Top10 的 Marker 基因是由 gene_diff 由大到小来排列的。pct1为表达 Marker 基因的细胞在当前群中的占比。pct2为表达 Marker 基因的细胞在其余群中的占比。两者比值即为 gene_diff 的数值。')
		Marker_module.add_comment("每个细胞群中 Top10 Marker 基因结果表格：")
		Marker_module.add_comment("[{link}]({link})",link=link)
		Marker_module.add_table('*.Marker/top10_markers_for_each_cluster_anno.xls', caption = '每个细胞群 Top10 Marker 基因列表', show_rows=10 , headerdict={'gene':'基因名','p_val':'p值','avg_log2FC':'对数转化后的平均Foldchange值','pct.1':'表达Marker基因的细胞在当前群中的占比','pct.2':'表达Marker基因的细胞在其余群中的占比','p_val_adj':'校正后的p值','cluster':'细胞群编号','gene_diff':'pct.1与pct.2的比值。Top10 Marker以gene_diff列为筛选依据。','ensembl_id':'ensembl基因ID','Dbxref_GeneID':' NCBI基因ID索引号','gene_type':'基因的类型','gene_description':'基因描述','GO_id':'Gene Ontology登录号','GO_term':'GO条目描述','pathway':'KEGG通路号','pathway_description':'KEGG通路描述'})

		## heatmap
		heatmap_plots = list(glob('*.Marker/topmarker_gene_heatmap.png'))
		heatmap_contents = ['Top10 Marker 基因表达热图。图片说明：横坐标为细胞群，纵坐标为 Marker 基因，图中红色表示高表达，蓝色表示低表达。']
		Marker_module.add_plot(list(zip(heatmap_plots, heatmap_contents)), caption = 'Top10 Marker 基因表达热图', description = '图片说明：横坐标为细胞群，纵坐标为 Marker 基因，图中红色表示高表达，蓝色表示低表达。')
		## feature 
		Marker_module.add_comment('每个细胞群中 Top10 Marker 基因的可视化展示如下：')
		feature_plots = ["*.Marker/top10_markers_visualize_for_each_cluster/markers_vis4cluster"+str(i+1)+"/marker_gene_featureplot.png" for i in range(marker_cluster_num) ]
		feature_contents = ["第 "+str(i+1)+" 群细胞的 Top10 Marker 基因在 " + Reduct2 + "聚类结果中的可视化图。图片说明：红色越深表示该细胞中对应基因的表达量越高。" for i in range(len(feature_plots)) ]    ### str(i+1)
		Marker_module.add_plot(list(zip(feature_plots, feature_contents)), caption = f'Top10 Marker 基因在 {Reduct2} 聚类结果中的可视化图', description = '图片说明：红色越深表示该细胞中对应基因的表达量越高。')
		## vlnplot
		vln_plots = ["*.Marker/top10_markers_visualize_for_each_cluster/markers_vis4cluster"+str(i+1)+"/marker_gene_violin_plot.png" for i in range(marker_cluster_num) ]
		vln_contents = ["第 "+str(i+1)+" 群细胞的 Top10 Marker基因表达量小提琴图。图片说明：横坐标为细胞群的编号，纵坐标为标准化后的基因表达值。" for i in range(len(vln_plots)) ]    ### str(i+1)
		Marker_module.add_plot(list(zip(vln_plots, vln_contents)), caption = 'Top10 Marker 基因表达量小提琴图', description = '图片说明：横坐标为细胞群编号，纵坐标为标准化后的基因表达值。')
	
	## ========================= 2.4.6 细胞类型鉴定 ========================= 
	if len(list(glob("*.Reference_celltype"))) != 0:
		report_hyperlink_list.append('''[细胞类型鉴定结果](#celltyping_results)\n\n''')
		celltype_folder = list(glob(r"[0-9]*.Reference_celltype"))
		# summary
		celltype_file = list(glob(f'{celltype_folder[0]}/*_simplified_celltyping_results.csv'))
		celltype_results = pd.read_csv(celltype_file[0], sep=',')
		celltype = '， '.join([ str(i) for i in set(celltype_results['celltype']) ])
		report_summary_list.append(f"，供参考的细胞类型有 {celltype} 。" )
		Celltype_module = result_module.add_section('细胞类型鉴定', nav_emphasize = True, nav_title = "项目核心内容")
		# check cluster number
		celltyping_cluster_num = max(celltype_results['clusters'])
		if 'correlation_cluster_num' in locals():
			if celltyping_cluster_num != correlation_cluster_num:
				logging_exit("× Reference_celltype 中的细胞群数与 Clusters_correlation 中的细胞群数不一致，请核查!",log_file)
			else:
				# if glob.glob(f[0] +'/*_top*_celltyping_on_*_resolution*_plot.pdf')[0].split('/')[-1].startswith(species.capitalize()):
				logging("√ Reference_celltype 中的细胞群数与 Clusters_correlation 中的细胞群数一致。",log_file)
				# else:
				# 	print("× Reference_celltype 中物种选用错误，应为 %s ，请核查!!!" %(species.capitalize()))
		else:
			logging("? Reference_celltype 目录下文件数一致，但未知与 Clusters_correlation 中的细胞群数关系，请先确定 Clusters_correlation 群数后再次核查！",log_file,WARNING)
		link = list(glob(f'{celltype_folder[0]}/*top.*celltyping_plot.pdf'))[0]
		refcelltype = str(link).split('/')[-1].split("_")[1]
		ref_species_dict = {"hpca":"Human","blueprint_encode":"Human","schcl":"Human","immgen":"Mouse","mouse.rnaseq":"Mouse","scmca":"Mouse"}
		if config["report"]["Species"].startswith("人"):
			if ref_species_dict[refcelltype] == "Human":
				logging("√ Reference_celltype 物种一致",log_file)
			else:
				logging_exit(f"× 本项目物种为人，但 Reference_celltype 使用了 {ref_species_dict[refcelltype]} 物种的 {refcelltype} 数据集 ，请核查。", log_file)
		elif config["report"]["Species"].startswith("小鼠") or config["report"]["Species"].startswith("大鼠"):
			if ref_species_dict[refcelltype] == "Mouse":
				logging("√ Reference_celltype 物种一致",log_file)
			else:
				logging_exit(f"× 本项目物种为小/大鼠，但 Reference_celltype 使用了 {ref_species_dict[refcelltype]} 物种的 {refcelltype} 数据集 ，请核查。", log_file)
		else:
			logging("? 本项目为特殊物种，请手动核查 Reference_celltype 参考数据集。",log_file)
		Celltype_module.add_comment(name=refcelltype.lower())

		Celltype_module.add_comment("数据集方法细胞类型鉴定参考结果见：")
		Celltype_module.add_comment("[{link}]({link})",link=link)
		
		Celltype_plots = list(glob(f'{celltype_folder[0]}/*top.*celltyping_plot.png'))
		Celltype_contents = [f'细胞类型参考结果图。图片说明：细胞类型注释结果在 {Reduct2} 图上的展示，每种细胞类型以不同颜色区分。']
		Celltype_plots = list(zip(Celltype_plots, Celltype_contents))
		Celltype_module.add_plot(Celltype_plots, caption = '细胞类型参考结果图',description = f'图片说明：细胞类型注释结果在 {Reduct2} 图上的展示，每种细胞类型以不同颜色区分。')
		link = list(glob(f'{celltype_folder[0]}/*celltyping_heatmap.pdf' ))[0]
		Celltype_module.add_comment("细胞类型鉴定相关性热图结果见：")
		Celltype_module.add_comment("[{link}]({link})",link=link)
		Celltype_heatmap_plots = list(glob(f'{celltype_folder[0]}/*celltyping_heatmap.png'))
		Celltype_heatmap_contents = ['细胞类型鉴定相关性热图。图片说明：纵轴表示每一个待鉴定的细胞，横轴表示参考数据集中的细胞类型注释名称。颜色越黄代表相关性值越大，表明待鉴定的细胞类型与参考数据集中的该细胞类型注释最为相似。']
		Celltype_heatmap_plots = list(zip(Celltype_heatmap_plots, Celltype_heatmap_contents))
		Celltype_module.add_plot(Celltype_heatmap_plots, 
			caption = '细胞类型鉴定相关性热图', 
			description = '图片说明：每一行表示参考数据集中的细胞类型注释名称，每一列表示待鉴定的细胞。颜色越黄表示相关性值越大，表明待鉴定的细胞类型与参考数据集中的该种细胞类型最为相似。')

		link = list(glob(f'{celltype_folder[0]}/*_simplified_celltyping_results.csv' ))[0]
		Celltype_module.add_comment("细胞类型注释表格见：")
		Celltype_module.add_comment("[{link}]({link})",link=link)
		Celltype_module.add_table(f'{celltype_folder[0]}/*_simplified_celltyping_results.csv', 
			caption = '细胞类型注释结果表格', show_rows=10 , 
			headerdict={'Barcode':'细胞Barcode','sampleid':'样本名称','celltype':'细胞类型注释','clusters':'细胞群','group':'样本分组'})

		link = get_url(f'{celltype_folder[0]}/', '*_celltyping_statistics.xls')
		Celltype_module.add_comment("各细胞群中的原始细胞类型数目统计表格见：")
		Celltype_module.add_comment("{link}",link=link)
	else :
		report_summary_list.append("。")
	## ========================= 2.4.7 差异表达基因及富集 ========================= 
	if len(list(glob("*.Diffexp"))) != 0:
		Diffexp_folder = list(glob(r"[0-9]*.Diffexp"))
		diff = pd.read_csv(f'{Diffexp_folder[0]}/diffexp_results_stat.xls' ,sep='\t')
		num_diff = len(diff)
		diff_num = ', '.join([ str(i) for i in diff.iloc[:,4]])
		report_summary_list.append(f"共设有 {num_diff} 个差异基因分组，其检测到的差异基因数量为: {diff_num}。" )
		
		report_hyperlink_list.append('''[差异基因分析结果](#diff_gene)\n\n[差异基因富集分析结果](#diff_enrich)\n\n''')
		diffexp = dict(config['report_params'])['diffexp_test']
		Diff_module = result_module.add_section('差异表达基因筛选', diffexp=diffexp)
		#link = '%s' %(Diffexp_folder[0])
		#diff_gene_c = Diff_module.add_comment('''详细结果见目录：[{link}]({link})''',link=link)
		link =  list(glob(f'{Diffexp_folder[0]}/*-all_diffexp_genes_anno.xls'))[0]
		Diff_module.add_comment("所有差异表达基因结果见:")
		Diff_module.add_comment("[{link}]({link})",link=link)
		link =  list(glob(f'{Diffexp_folder[0]}/*-diff-pval-0.05-FC-*_anno.xls'))[0] 
		Diff_module.add_comment("基于以上差异结果，进一步根据差异倍数（FoldChange）及显著性检验（pvalue）筛选显著的差异表达基因，结果见:")
		Diff_module.add_comment("[{link}]({link})",link=link)
		# if FC12 == True:
		if os.path.exists(f"{Diffexp_folder[0]}/FC1.2" ):
			link =  list(glob(f'{Diffexp_folder[0]}/FC1.2'))[0] 
			Diff_module.add_comment("存在差异分组在 pval < 0.05 & FC > 1.5 条件下基因数不足20个，筛选条件放宽至 pval < 0.05 & FC > 1.2 下差异结果请见:")
			Diff_module.add_comment("[{link}]({link})",link=link)
		Diff_module.add_comment("各分组差异基因数目统计表如下：")
		Diff_module.add_table(f'{Diffexp_folder[0]}/diffexp_results_stat.xls', 
			caption = '差异表达基因统计表')
            #,  
			#headerdict={'Case':'实验组名','Control':'对照组名','Up_diff':'显著上调差异基因数量','Down_diff':'显著下调差异基因数量','Total_diff(pvalue<0.05&FoldChange>1.5)':'显著性差异基因总数量'})
		Diff_module.add_table('header_stat.txt', caption = '各分组差异基因数据统计结果各列说明')
		Diff_module.add_comment("差异显著基因结果示例：")
		difffiles = list(glob(f'{Diffexp_folder[0]}/*diff*pval*xls' ))
		Diff_module.add_table(difffiles[0], 
			caption = '差异显著基因结果表格',
			show_rows =10 )
		Diff_module.add_table('header_diffexp.txt', caption = '差异显著基因结果各列说明')
		#,headerdict={'GeneID':'基因名','pvalue':'p值','pct.1':'表达该基因的细胞在比较组细胞群中的占比','pct.2':'表达该基因的细胞在对照组细胞群中的占比','padj':'校正后的p值','FoldChange':'差异倍数','log2FoldChange':'log2转化后的差异倍数','up_down':'基因上下调描述','ensembl_id':'ensembl基因ID','Dbxref_GeneID':' NCBI基因ID索引号','gene_type':'基因的类型','gene_description':'基因描述','GO_id':'Gene Ontology登录号','GO_term':'GO条目描述','pathway':'KEGG通路号','pathway_description':'KEGG通路描述'})

		Diff_module.add_comment("将差异基因的差异倍数（FoldChange）从大到小排列，上下调各选取 20 个基因绘制热图：")
		topdiff_heatmap_plots = list(glob(f'{Diffexp_folder[0]}/*_heatmap.png'))
		topdiff_heatmap_plots = [ str(i) for i in topdiff_heatmap_plots ]
		topdiff_heatmap_prefix = [re.findall("top(.*)_heatmap.png",i)[0]  for i in topdiff_heatmap_plots]
		topdiff_heatmap_contents = [j+' 上下调 Top20 差异基因热图。图片说明：横坐标为差异分组信息，纵坐标为上下调 Top20 基因（如果上下调差异基因不足20个，则绘制全部基因；线粒体基因和核糖体基因默认不进行绘图）。图中红色表示高表达，蓝色表示低表达。' for j in topdiff_heatmap_prefix]
		Diff_module.add_plot(list(zip(topdiff_heatmap_plots, topdiff_heatmap_contents)), 
			caption = '上下调 Top20 差异基因热图', 
			description = '图片说明：横坐标为差异分组信息，纵坐标为上下调 Top20 基因（如果上下调差异基因不足20个，则绘制全部基因；线粒体基因和核糖体基因默认不进行绘图）。图中红色表示高表达，蓝色表示低表达。')
		
		## ========================= 2.4.8 差异基因GO富集分析 ========================= 
		enrichment_folder = list(glob(r"[0-9]*enrichment"))
		enrich_module = result_module.add_section('差异基因富集分析')
		#定义函数获取比较组名称
		def get_diffgroup_name(target,tag):
			diff_group = []
			for f in Path(target).glob(tag):
				t = str(f).split('/')[-1]
				t = t.split('-diff')[0]
				diff_group.append(t)
			return diff_group
				
		link = f'{enrichment_folder[0]}/GO_enrichment'
		diff_group = get_diffgroup_name(Diffexp_folder[0], '*diff*FC*.xls')
		diff_gene_GO = enrich_module.add_section('差异基因 GO 富集分析')
		diff_gene_GO.add_plot('enrich.png',
			caption='超几何分布检验计算 p 值的公式和 Enrichment score 计算公式',
			content='超几何分布检验计算 p 值的公式和 Enrichment score 计算公式。其中，N 为所有基因中具有 GO 注释的基因数目；n 为 N 中差异表达基因中具有 GO 注释的基因数目；M 为所有基因中注释为某特定 GO Term 的基因数目；m 为注释为某特定 GO Term 的差异表达基因数目。可以根据 GO 分析的结果结合生物学意义从而挑选用于后续研究的基因。',
			description='其中，N 为所有基因中具有 GO 注释的基因数目；n 为 N 中差异表达基因中具有 GO 注释的基因数目；M 为所有基因中注释为某特定 GO Term 的基因数目；m 为注释为某特定 GO Term 的差异表达基因数目。可以根据 GO 分析的结果结合生物学意义从而挑选用于后续研究的基因。')
		diff_gene_GO.add_comment('''输出文件结果目录：
		[{link}]({link})''',link=link)
		
		diff_gene_GO.add_comment("GO 富集分析结果示例：")
		diff_gene_GO.add_table(f'{enrichment_folder[0]}/GO_enrichment/{diff_group[0]}/enrichment-go-*-Total.xls',
			caption='富集分析结果表格',
			show_rows=10)
			#headerdict={'id':'条目在Gene Ontology的登录号','term':'该条目的描述','category':'GO分类','ListHits':'该GO条目中差异基因数','ListTotal':'注释到GO的总差异基因数','PopHits':'注释到该条目中的所有基因数目','PopTotal':'注释到GO的总基因数','pval':'富集显著性p值','padj':'校正后的p值','Enrichment_score':'富集打分','Gene':'属于该条目的差异gene'})
		diff_gene_GO.add_table('header_enrich_go.txt', caption = 'GO 富集分析结果各列说明')
		diff_gene_GO3_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/GO.top.*.png'))
		if len(diff_gene_GO3_plots) >0:
			diff_gene_GO.add_comment('''GO 富集分析 top30 （筛选三种分类中对应差异基因数目大于 2 的 GO 条目，按照每个条目对应的 -log<sub>10</sub>pValue 由大到小排序的各 10 条）条形图展示如下：''')
			diff_gene_GO3_contents = ['GO 富集分析结果展示。图片说明：图中横轴为 GO 条目名称，纵轴为 -log<sub>10</sub>pValue。']*len(diff_gene_GO3_plots)
			diff_gene_GO.add_plot(list(zip(diff_gene_GO3_plots, diff_gene_GO3_contents)),
				caption='GO 富集分析结果展示',
				#description='图片说明：图中横轴为 GO 条目名称，纵轴为 -log<sub>10</sub>pValue。'
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV1wS4y1z75L/)\n\n图片说明：图中横轴为 GO 条目名称，纵轴为 -log<sub>10</sub>Pvalue。'
				)
			diff_gene_cohord_c3_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/GO.*chord*.png'))
		if len(diff_gene_cohord_c3_plots) >0:
			diff_gene_GO.add_comment('''富集分析和弦图，显示 p-value 最小的 10 个分类：''')
			diff_gene_cohord_c3_contents = ['GO 富集 Top10 和弦图。图片说明：左侧为每个分类中 |log2FC| 最大的 10 个基因，右侧反映分类组成情况，中间线条表示分类、基因对应关系。外侧热图表示对应基因的 log2FC 值。']*len(diff_gene_cohord_c3_plots)
			diff_gene_GO.add_plot(list(zip(diff_gene_cohord_c3_plots, diff_gene_cohord_c3_contents)),
				caption='GO 富集 Top10 和弦图',
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV1PF411j7Hq/)\n\n图片说明：左侧为每个分类中 |log2FC| 最大的 10 个基因，右侧反映分类组成情况，中间线条表示分类、基因对应关系。外侧热图表示对应基因的 log2FC 值。')
			diff_gene_GO_circle_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/enrichment-go-*-Total.circos.png'))
		if len(diff_gene_GO_circle_plots) >0:
			diff_gene_GO.add_comment('''GO 富集分析圈图，显示 p-value 最小的 20 个分类，从外到内共四圈：''')
			diff_gene_GO_circle_plots_contents = ['差异表达基因及所有基因在 GO 富集分析圈图。图片说明：第一圈：富集的分类，圈外为基因数目的坐标尺。不同的颜色代表不同的分类；第二圈：背景基因中该分类的数目以及 p-value。基因越多条形越长，值越小颜色越红，越大越蓝；第三圈：上下调基因比例条形图，浅红色代表上调基因比例，浅蓝色代表下调基因比例；下方显示具体的数值；第四圈：各分类的 RichFactor 值(该分类中前景基因数量除以背景基因数量)，背景辅助线每个小格表示0.2。']*len(diff_gene_GO_circle_plots)
			diff_gene_GO.add_plot(list(zip(diff_gene_GO_circle_plots, diff_gene_GO_circle_plots_contents)),
				caption='差异表达基因及所有基因在 GO 富集分析圈图',
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV15a411E7Le?spm_id_from=333.999.0.0)\n\n图片说明：第一圈：富集的分类，圈外为基因数目的坐标尺。不同的颜色代表不同的分类；第二圈：背景基因中该分类的数目以及 p-value。基因越多条形越长，值越小颜色越红，越大越蓝；第三圈：上下调基因比例条形图，浅红色代表上调基因比例，浅蓝色代表下调基因比例；下方显示具体的数值；第四圈：各分类的 RichFactor 值(该分类中前景基因数量除以背景基因数量)，背景辅助线每个小格表示 0.2。')
		# if len(list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/topGO_*.png' )))>0 :
			# diff_gene_GO.add_comment('''
# 使用 fisher 算法分别对样本间差异基因进行 CC，BP，MF 富集分析，并使用 topGO[^topGO] 对富集到的 Term 绘制有向无环图。topGO 有向无环图能直观展示差异表达基因富集的 GO 节点（Term）及其层级关系，是差异表达基因 GO 富集分析的结果图形化展示，分支代表的包含关系，从上至下所定义的功能描述范围越来越具体。
# [^topGO]:Alexa A, Rahnenfuhrer J. topGO: enrichment analysis for gene ontology. R package version 2.8,2010.''')
			# diff_gene_GO.add_plot('topGO.png',
				# caption='差异基因topGO有向无环示例图展示',
				# content='差异基因topGO有向无环示例图展示。图片说明：对每个 GO Term 进行富集，最显著的 10 个节点用矩形表示。矩形的颜色代表富集显著性，从黄色到红色显著性越来越高。每个节点的基本信息显示在相应的图形中，为 GO ID 和 GO Term。',
				# description='''图片说明：对每个 GO Term 进行富集，最显著的 10 个节点用矩形表示。矩形的颜色代表富集显著性，从黄色到红色显著性越来越高。每个节点的基本信息显示在相应的图形中，为 GO ID 和 GO Term。''')
		
		#diff_gene_GO5_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/ALL_vs_DEG.GO.level2.stat.png'))
		#if len(diff_gene_GO5_plots)>0:
		#	diff_gene_GO.add_comment("根据功能分级，一般将 GO 分为三个层级，level1 包含三个条目：biological process、cellular component和molecular function，level2 包含 biological adhesion、cell 和 binding 等 64 个条目，level3 即为常规富集使用的数万个条目。从 level1到 level3 功能更具体，反之，更概括。")
		#	diff_gene_GO.add_comment("差异基因和所有基因在 GO Level2 水平分布比较图如下：")
        #
		#	diff_gene_GO5_contents = ['差异表达基因及所有基因在 GO Level2 水平分布比较图。图片说明：蓝色表示所有基因富集的 GO Level2 条目，红色表示差异基因富集的 GO Level2 条目，横轴为条目名称，纵轴表示对应条目的基因数量和其百分比。']*len(diff_gene_GO5_plots)
		#	diff_gene_GO5_plots = list(zip(diff_gene_GO5_plots, diff_gene_GO5_contents))
		#	diff_gene_GO.add_plot(diff_gene_GO5_plots,
		#		caption='差异表达基因及所有基因在 GO Level2 水平分布比较图',
		#		description='图片说明：蓝色表示所有基因富集的 GO Level2 条目，红色表示差异基因富集的 GO Level2 条目，横轴为条目名称，纵轴表示对应条目的基因数量和其百分比。')
		#				
		#diff_gene_GO6_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/Up_vs_Down.GO.level2.stat.png'))
		#if len(diff_gene_GO6_plots)>0:
		#	diff_gene_GO.add_comment('''上调差异基因和下调差异基因在 GO Level2 水平分布比较图如下：''')
		#	diff_gene_GO6_plots = list(glob(f'{enrichment_folder[0]}/GO_enrichment/*/Up_vs_Down.GO.level2.stat.png'))
		#	#diff_gene_GO6_contents = ['上调差异基因和下调差异基因在 GO Level2 水平分布比较图。图片说明：红色表示上调差异表达基因富集的 GO Level2 条目，绿色表示下调差异表达基因富集的 GO Level2 条目，横轴为条目名称，纵轴表示对应条目的基因数量和其百分比']*len(diff_gene_GO6_plots)
		#	diff_gene_GO6_plots = list(zip(diff_gene_GO6_plots, diff_gene_GO5_contents))
		#	diff_gene_GO.add_plot(diff_gene_GO6_plots,
		#		caption='上调差异基因和下调差异基因在 GO Level2 水平分布比较图',
		#		description='图片说明：红色表示上调差异表达基因富集的 GO Level2 条目，绿色表示下调差异表达基因富集的 GO Level2 条目，横轴为条目名称，纵轴表示对应条目的基因数量和其百分比。')
		## ========================= 2.4.9 差异基因KEGG富集分析 ========================= 
		link = f'{enrichment_folder[0]}/KEGG_enrichment' 
		diff_gene_KEGG = enrich_module.add_section('差异基因 KEGG 富集分析')
		diff_gene_KEGG.add_comment('''差异基因 KEGG 富集分析结果：[{link}]({link})''',link=link)
		
		diff_gene_KEGG_top20_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/KEGG.top.*.png'))
		if len(diff_gene_KEGG_top20_plots)>0:
			diff_gene_KEGG.add_comment("KEGG 富集分析 Top20（筛选对应差异基因数目大于 2 的 Pathway 条目，按照每个条目对应的 -log<sub>10</sub>Pvalue 由大到小排序）气泡图如下：")
			diff_gene_KEGG_top20_contents = ['KEGG 富集 Top20 气泡图。图片说明：图中横轴 Enrichment Score 为富集分值，气泡越大的条目包含的差异蛋白编码基因数目越多，气泡颜色由紫-蓝-绿-红变化，其富集 pValue 值越小，显著程度越大。']*len(diff_gene_KEGG_top20_plots)
			diff_gene_KEGG_top20_plots = list(zip(diff_gene_KEGG_top20_plots, diff_gene_KEGG_top20_contents))
			diff_gene_KEGG.add_plot(diff_gene_KEGG_top20_plots,
				caption='KEGG 富集 Top20 气泡图',
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV17a411E7nR?spm_id_from=333.999.0.0)\n\n图片说明：图中横轴 Enrichment Score 为富集分值，气泡越大的条目包含的差异蛋白编码基因数目越多，气泡颜色由蓝-白-黄-红变化，其富集 p-value 值越小，显著程度越大。')
			diff_gene_cohord_c3_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/KEGG.*chord*.png'))
		if len(diff_gene_cohord_c3_plots)>0:
			diff_gene_KEGG.add_comment("富集分析和弦图，显示 p-value 最小的 10 个分类，图形分为左右两侧：左侧为每个分类中 |log2FC| 最大的 10 个基因，外侧热图表示对应基因的 log2FC 值：")
			diff_gene_cohord_c3_contents = ['KEGG富集 Top10 和弦图。图片说明：右侧反映分类组成情况，中间线条表示分类、基因对应关系。']*len(diff_gene_cohord_c3_plots)
			diff_gene_cohord_c3_plots = list(zip(diff_gene_cohord_c3_plots, diff_gene_cohord_c3_contents))
			diff_gene_KEGG.add_plot(diff_gene_cohord_c3_plots,
				caption='KEGG 富集 Top10 和弦图',
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV1jY4y167D7?spm_id_from=333.999.0.0)\n\n图片说明：右侧反映分类组成情况，中间线条表示分类、基因对应关系。')

			diff_gene_KEGG_circle_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/enrichment-kegg-*-Total.circos.png'))
		if len(diff_gene_KEGG_circle_plots)>0:
			diff_gene_KEGG.add_comment("KEGG 富集分析圈图，显示 p-value 最小的 20 个分类，从外到内共四圈：")
			diff_gene_KEGG_circle_contents = ['差异表达基因及所有基因在 KEGG 富集分析圈图图片说明：右侧反映分类组成情况，中间线条表示分类、基因对应关系。']*len(diff_gene_KEGG_circle_plots)
			diff_gene_KEGG_circle_plots = list(zip(diff_gene_KEGG_circle_plots, diff_gene_KEGG_circle_contents))
			diff_gene_KEGG.add_plot(diff_gene_KEGG_circle_plots,
				caption='差异表达基因及所有基因在 KEGG 富集分析圈图',
				description='[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV1RB4y197nQ?spm_id_from=333.999.0.0)\n\n图片说明：第一圈：富集的分类，圈外为基因数目的坐标尺。不同的颜色代表不同的分类；第二圈：背景基因中该分类的数目以及 p-value。基因越多条形越长，值越小颜色越红，越大越蓝；第三圈：上下调基因比例条形图，浅红色代表上调基因比例，浅蓝色代表下调基因比例；下方显示具体的数值；第四圈：各分类的 RichFactor 值(该分类中前景基因数量除以背景基因数量)，背景辅助线每个小格表示 0.2。')

		# diff_gene_KEGG_level2_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/ALL_vs_DEG.KEGG_Classification.png' ))
		# if len(diff_gene_KEGG_level2_plots)>0:
			# diff_gene_KEGG.add_comment('''根据功能分级，通常将 KEGG 分为三个层级，level1 包含六个分类：Metabolism、Genetic Information Processing、Environmental Information Processing、Cellular Processes、Organismal Systems 和 Human Diseases（具体物种注释可能有删减）。level2 包含 Cell growth and death、Transcription 和 Development 等 44 个分类（具体物种注释可能有删减），level3 即为常规富集使用的数百个 Pathway，从 level1 到 level3 功能更具体，反之，更概括。''')
			# diff_gene_KEGG.add_comment("差异表达基因及所有基因在 KEGG Level2 水平分布比较图如下：")
			# diff_gene_KEGG_level2_contents = ['差异表达基因及所有基因在 KEGG Level2 水平分布比较图。图片说明：横轴是注释到各 Level2 通路的基因（差异表达基因）和所有注释到 KEGG 通路的基因（差异表达基因）总数的比值（%），纵轴表示 Level2 Pathway 的名称，柱子右边数字代表注释到该Level2 Pathway下的差异表达基因数量。']*len(diff_gene_KEGG_level2_plots)
			# diff_gene_KEGG_level2_plots = list(zip(diff_gene_KEGG_level2_plots, diff_gene_KEGG_level2_contents))
			# diff_gene_KEGG.add_plot(diff_gene_KEGG_level2_plots,
				# caption='差异表达基因及所有基因在 KEGG Level2 水平分布比较图',
				# description='图片说明：横轴是注释到各 Level2 通路的基因（差异表达基因）和所有注释到 KEGG 通路的基因（差异表达基因）总数的比值（%），纵轴表示 Level2 Pathway 的名称，柱子右边数字代表注释到该Level2 Pathway下的差异表达基因数量。')
						
		# diff_gene_KEGG_updown_level2_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/Up_vs_Down.KEGG_Classification.png' ))
		# if len(diff_gene_KEGG_updown_level2_plots)>0:
			# diff_gene_KEGG.add_comment('上调差异表达基因及下调差异表达基因在 KEGG Level2 水平分布图如下：')
			# diff_gene_KEGG_updown_level2_plots = list(glob(f'{enrichment_folder[0]}/KEGG_enrichment/*/Up_vs_Down.KEGG_Classification.png'))
			# diff_gene_KEGG_updown_level2_contents = ['上调差异表达基因及下调差异表达基因在 KEGG Level2 水平分布图。图片说明：横轴是注释到各 Level2 通路的上调（下调）差异表达基因和所有注释到 KEGG 通路的上调（下调）差异表达基因总数的比值（%），纵轴表示 Level2 Pathway 的名称，柱子右边数字代表注释到该 Level2 Pathway 的上调（下调）差异表达基因数量。']*len(diff_gene_KEGG_updown_level2_plots)
			# diff_gene_KEGG_updown_level2_plots = list(zip(diff_gene_KEGG_updown_level2_plots, diff_gene_KEGG_updown_level2_contents))
			# diff_gene_KEGG.add_plot(diff_gene_KEGG_updown_level2_plots,
				# caption='上调差异表达基因及下调差异表达基因在 KEGG Level2 水平分布图',
				# description='图片说明：横轴是注释到各 Level2 通路的上调（下调）差异表达基因和所有注释到 KEGG 通路的上调（下调）差异表达基因总数的比值（%），纵轴表示 Level2 Pathway 的名称，柱子右边数字代表注释到该 Level2 Pathway 的上调（下调）差异表达基因数量。')
		
		## ========================= 2.4.10 差异基因PPI富集分析 =========================
		ppi_folder = list(glob(r"[0-9]*ppi"))
		if len(ppi_folder)>0: 
			ppi_module = result_module.add_section('差异基因蛋白网络互作分析')
			link = ppi_folder[0]
			ppi_module.add_comment('''结果目录：[{link}]({link})''',link=link)
			ppi_module.add_comment('''差异基因互作关系结果文件：''')
			ppi_table = list(glob(f'{ppi_folder[0]}/*_protein-protein-interaction.tsv' ))[0]
			ppi_module.add_table(ppi_table, 
				caption='差异基因互作关系表',show_rows=10)
			ppi_module.add_table('header_ppi.txt', caption = '差异基因互作关系结果各列说明')

			# ppi_module.add_table(ppi_table, 
				# caption='差异基因互作关系表',show_rows=10, 
				# headerdict={'stringId_A':'基因A的stringId','stringId_B':'基因B的stringId','preferredName_A':'A基因名','preferredName_B':'B基因名','ncbiTaxonId':'NCBI的物种分类标识符','score':'结合不同渠道证据的概率矫正后的综合得分','nscore':'邻近得分（从基因间核苷酸计数计算）','fscore':'融合得分（来自其他物种的融合蛋白质）','pscore':'系统谱系的共存得分（源自相似的基因缺失/存在模式）','ascore':'共表达得分（源自由DNA阵列和类似技术测量相似的mRNA表达模式）','escore':'实验得分（来自实验数据，如亲和色谱）','dscore':'数据库得分（派生自各种数据库的精选数据）','tscore':'文本挖掘得分（源自摘要中同时存在的基因/蛋白质名称）'})
			
			ppi_module.add_comment("上下调 Top25 差异表达基因互作网络图展示如下：")
			ppi_plots = list(glob(f'{ppi_folder[0]}/*string_protein-protein-interaction.new_colors.png'))
			ppi_plots = [ str(i) for i in ppi_plots ]
			ppi_contents = ['差异基因互作网络图。图片说明：红色圆圈表示上调表达基因，绿色圆圈表示下调表达基因，节点之间的连线（或称为边）表示两蛋白之间具有相互作用，线的粗细表示相互作用关系的可靠性。']*len(ppi_plots)
			ppi_plots = list(zip(ppi_plots, ppi_contents))
			ppi_module.add_plot(ppi_plots, caption = '差异基因互作网络图', 
				description = '图片说明：红色圆圈表示上调表达基因，绿色圆圈表示下调表达基因，节点之间的连线（或称为边）表示两蛋白之间具有相互作用，线的粗细表示相互作用关系的可靠性。')
			ppi_module.add_comment("上下调 Top25 差异表达基因互作圆形图展示如下：")
			ppi_plots = list(glob(f'{ppi_folder[0]}/*top_25_ppi_network.png'))
			ppi_plots = [ str(i) for i in ppi_plots ]
			ppi_contents = ['差异基因互作圆形图。图片说明：红色表示上调差异表达基因，蓝色表示下调差异表达基因；关联的基因越多，基因点越大。']*len(ppi_plots)
			ppi_plots = list(zip(ppi_plots, ppi_contents))
			ppi_module.add_plot(ppi_plots, caption = '差异基因互作圆形图', 
				description = '[点击此处查看完整图片解读视频](https://www.bilibili.com/video/BV1X54y1Z7XW?spm_id_from=333.999.0.0)\n\n图片说明：红色表示上调差异表达基因，蓝色表示下调差异表达基因；关联的基因越多，基因点越大。')

	## 2.1
	## ========================= 2.1.1 项目摘要、快捷链接  =========================  
	project_module.add_section(name="项目摘要",description=''.join(report_summary_list))
	## ========================= 2.1.2 项目快捷链接 =========================
	link_faq = supp_dir + '/单细胞转录组常见问题(FAQ).pdf'
	link_down = supp_dir + '/单细胞转录组项目数据挖掘建议.pdf'
	link0 = supp_dir + '/Loupe-Browser使用教程.html'
	link_video = 'https://www.bilibili.com/video/BV1cz4y1y7rs'
	report_hyperlink_list.append(f'''[单细胞转录组常见问题（FAQ）]({link_faq})\n\n[Loupe-Browser 软件使用教程]({link0})\n\n[报告解读视频]({link_video})\n''' )
	report_hyperlink = ''.join(report_hyperlink_list) 
	project_module.add_section(name="项目快捷链接",description=report_hyperlink)#anchor: linkage

	#########################################################################
	## ========================= 2.5 SECTION 5 附录 ========================= 
	#########################################################################
	appendix_module = report.add_section('附录')

	appendix_module.add_section('报告解读视频',link_video=link_video)
	### ========================= 2.5.1 loupe browser =========================  
	#appendix_module.add_section('Loupe-Browser使用教程',link0=link0)
	#
	### ========================= 2.5.2 实验技术方法说明 ========================= 
	#link1 = 'supplemental_material/欧易生物单细胞转录组实验技术方法说明_中文.pdf'
	#link2 = 'supplemental_material/欧易生物单细胞转录组实验技术方法说明_英文.pdf'
	#appendix_module.add_section('实验技术方法说明',link1=link1,link2=link2)

	## ========================= 2.5.3 生信分析方法说明  ========================= 
	link3 = supp_dir + '/欧易生物单细胞转录组生信分析方法_中文.pdf'
	link4 = supp_dir + '/欧易生物单细胞转录组生信分析方法_英文.pdf'
	appendix_module.add_section('生信分析方法说明',link3=link3,link4=link4)

	## ========================= 2.5.4 下游分析建议 ========================= 
	appendix_module.add_section('下游分析建议',link_down=link_down)

	## ========================= 2.5.5 FAQ ========================= 
	appendix_module.add_section('常见问题FAQ',link_faq=link_faq)

	## ========================= 2.5.6 AI修图使用说明 ========================= 
	link_ai = supp_dir + '/AI使用说明.html'
	appendix_module.add_section('AI修图使用说明',link_ai=link_ai)
	
	## ========================= 2.5.6 软件及数据库信息  ========================= 
	#database = pd.DataFrame([['GO Database','http://geneontology.org/'],['KEGG Database','http://www.genome.jp/kegg/']])
	# database.columns = ['使用数据库', '网页链接']
	database = pd.read_table('../../../scripts/report_BD/pic/tables/scRNA_database.txt', sep='\t')
	with open(f'{config["report"]["Reference"]}/config.yaml') as f:
		reference_config=yaml.safe_load(f)
	database = database.append([{"使用数据库":"Reference genome","网页链接":reference_config["genome_linkage"],"版本":reference_config["genome_version"]}])
	database = database.append([{"使用数据库":"Reference genome annotation","网页链接":reference_config["annotation_linkage"],"版本":reference_config["annotation_version"]}])
	if vdj_type=="dan":
		database = database.append([{"使用数据库":"AbSeq Reference ","网页链接":"https://abseq-ref-gen.genomics.bd.com/","版本":reference_config["annotation_version"]}])

	supply_section_database = appendix_module.add_section('数据库信息',description='')
	supply_section_database.add_table(database,caption='数据库信息')
	appendix_module.add_section('数据分析软件')
	appendix_module.add_table('pic/tables/scRNA_software.txt', caption = '使用软件及版本')
	#########################################################################
	## ========================= 2.6 SECTION 6 申明 =========================
	#########################################################################
	report.add_section('申明')
	
	#########################################################################
	## =========================   3.  写入html     =========================
	#########################################################################
	# Generate Report HTML
	report.write_to('report.html', zip_report_name=f'{outdir}.zip' )
	log_file.close()

if __name__ == "__main__":
	scrna_report()
